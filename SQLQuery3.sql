


use PROYECTO_CONTROL_HORAS



ALTER TABLE FACTURA_PROYECTO
DROP CONSTRAINT ID_FACTURA_FK


ALTER TABLE FACTURA_PROYECTO
DROP CONSTRAINT [ID_PROYECTOFACTURA_FK]


DROP TABLE FACTURA_PROYECTO


ALTER TABLE FACTURA
DROP COLUMN FECHA

ALTER TABLE FACTURA
DROP COLUMN MONTO


ALTER TABLE FACTURA 
DROP COLUMN IVA


ALTER TABLE FACTURA
DROP COLUMN TOTAL

USE PROYECTO_CONTROL_HORAS


ALTER TABLE FACTURA
ADD ID_PROYECTO INT NOT NULL


ALTER TABLE FACTURA
ADD CONSTRAINT ID_PRO_FAC FOREIGN KEY(ID_PROYECTO) REFERENCES PROYECTO(ID)

ALTER TABLE FACTURA
ADD IDCUENTA INT NOT NULL


alter PROCEDURE [dbo].[CREAR_PROYECTO]
@MONTO DECIMAL(10,2),
@MONEDA VARCHAR(200),
@AFECTAIVA VARCHAR(10),
@ID_TIPOLOGIA INT,
@NOMBRE VARCHAR(MAX),
@NUM_PROYECTO VARCHAR(MAX),
@FECHA_INICIO DATE,
@FECHA_TERMINO DATE,
@PLAZO INT,
@TIPO_EMPRESA INT,
@ID_CCOSTO_UNEGOCIO INT,
@ID_CLIENTE_SUCURSAL INT,
@STATUS_PROYECTO INT,
@PROBABILIDAD VARCHAR(200),
@PORCENTAJE_PROBABILIDAD DECIMAL(10,2),
@FECHA_PLAZO_NEG DATE,
@HHSOCIOS INT,
@IDCUENTASOCIO INT,
@HHSTAFF INT,
@IDCUENTASTAFF INT,
@HHCONSULTORA INT,
@IDCUENTACONSULTORA INT,
@HHCONSULTORB INT,
@IDCUENTACONSULTORB INT,
@HHCONSULTORC INT,
@IDCUENTACONSULTORC INT,
@IDCUENTAFACTURA INT,
@ID_PROYECTO INT OUTPUT
AS
BEGIN
DECLARE @ID_PRESUPUESTO INT;
 
 DECLARE @MONTOIVA DECIMAL(10,2) = 0;
 IF(@AFECTAIVA = 'si')
 BEGIN
 SET @MONTOIVA = @MONTO * 0.19;
 END;
INSERT INTO PRESUPUESTO (MONTO,MONEDA,AFECTAIVA,MONTOIVA) VALUES (@MONTO,@MONEDA,@AFECTAIVA,@MONTOIVA)

SET @ID_PRESUPUESTO= SCOPE_IDENTITY();

INSERT INTO PROYECTO(ID_PRESUPUESTO,ID_TIPOLOGIA,NOMBRE,NUM_PROYECTO,FECHA,FECHA_INICIO,FECHA_TERMINO,PLAZO,TIPO_EMPRESA,ID_CCOSTO_UNEGOCIO,ID_CLIENTE_SUCURSAL,
STATUS_PROYECTO,PROBABILIDAD,PORCENTAJE_PROBABILIDAD,FECHA_PLAZO_NEG)
VALUES(@ID_PRESUPUESTO,@ID_TIPOLOGIA,@NOMBRE,@NUM_PROYECTO,GETDATE(),@FECHA_INICIO,@FECHA_TERMINO,@PLAZO,@TIPO_EMPRESA,@ID_CCOSTO_UNEGOCIO,@ID_CLIENTE_SUCURSAL
,@STATUS_PROYECTO,@PROBABILIDAD,@PORCENTAJE_PROBABILIDAD,@FECHA_PLAZO_NEG)




SET @ID_PROYECTO = SCOPE_IDENTITY();

INSERT INTO FACTURA (ID_PROYECTO,IDCUENTA) VALUES (@ID_PROYECTO,@IDCUENTAFACTURA)


IF(@HHSOCIOS>0)
BEGIN
INSERT INTO USUARIO_PROYECTO (ID_PROYECTO, ID_USUARIO,HH_SOCIOS,IDCUENTA)
        SELECT @ID_PROYECTO, U.ID,@HHSOCIOS,@IDCUENTASOCIO
        FROM USUARIO U
        INNER JOIN RECURSO R ON U.ID_RECURSO = R.ID
        WHERE R.NOMBRE_RECURSO = 'Socio';
END;
IF(@HHSTAFF>0)
BEGIN
INSERT INTO USUARIO_PROYECTO (ID_PROYECTO, ID_USUARIO,HH_STAFF,IDCUENTA)
        SELECT @ID_PROYECTO, U.ID,@HHSTAFF,@IDCUENTASTAFF
        FROM USUARIO U
        INNER JOIN RECURSO R ON U.ID_RECURSO = R.ID
        WHERE R.NOMBRE_RECURSO = 'Staff';
END;
-- Para Consultores Externos
DECLARE @ConsultorA INT;
DECLARE @ConsultorB INT;
DECLARE @ConsultorC INT;

-- Asignar consultores A, B y C
SELECT 
    @ConsultorA = U.ID
FROM 
    USUARIO U
INNER JOIN 
    RECURSO R ON U.ID_RECURSO = R.ID
WHERE 
    R.NOMBRE_RECURSO = 'Consultor Externo'
ORDER BY 
    U.ID
OFFSET 0 ROWS FETCH NEXT 1 ROWS ONLY; -- Primer consultor (A)

SELECT 
    @ConsultorB = U.ID
FROM 
    USUARIO U
INNER JOIN 
    RECURSO R ON U.ID_RECURSO = R.ID
WHERE 
    R.NOMBRE_RECURSO = 'Consultor Externo'
ORDER BY 
    U.ID
OFFSET 1 ROWS FETCH NEXT 1 ROWS ONLY; -- Segundo consultor (B)

SELECT 
    @ConsultorC = U.ID
FROM 
    USUARIO U
INNER JOIN 
    RECURSO R ON U.ID_RECURSO = R.ID
WHERE 
    R.NOMBRE_RECURSO = 'Consultor Externo'
ORDER BY 
    U.ID
OFFSET 2 ROWS FETCH NEXT 1 ROWS ONLY; -- Tercer consultor (C)

-- Insertar horas para los consultores
IF (@HHCONSULTORA > 0 AND @ConsultorA IS NOT NULL)
BEGIN
    INSERT INTO USUARIO_PROYECTO (ID_PROYECTO, ID_USUARIO, HH_CONSULTORA,IDCUENTA)
    VALUES (@ID_PROYECTO, @ConsultorA, @HHCONSULTORA,@IDCUENTACONSULTORA);
END;

IF (@HHCONSULTORB > 0 AND @ConsultorB IS NOT NULL)
BEGIN
    INSERT INTO USUARIO_PROYECTO (ID_PROYECTO, ID_USUARIO, HH_CONSULTORB,IDCUENTA)
    VALUES (@ID_PROYECTO, @ConsultorB, @HHCONSULTORB,@IDCUENTACONSULTORB);
END;

IF (@HHCONSULTORC > 0 AND @ConsultorC IS NOT NULL)
BEGIN
    INSERT INTO USUARIO_PROYECTO (ID_PROYECTO, ID_USUARIO, HH_CONSULTORC,IDCUENTA)
    VALUES (@ID_PROYECTO, @ConsultorC, @HHCONSULTORC,@IDCUENTACONSULTORC);
END;



END;




ALTER PROCEDURE [dbo].[OBTENERPROYECTOS]
@ID INT,
@IDCLIENTE INT,
@NOMBRE VARCHAR(200),
@ID_TIPOEMPRESA INT,
@STATUS_PROYECTO INT,
@NUMPROYECTO VARCHAR(100),
@IDTIPOLOGIA INT,
@UNIDADNEGOCIO INT,
@IDCENTROCOSTO INT
AS
BEGIN
SELECT DISTINCT P.ID,P.NUM_PROYECTO,U.TIPO_UNEGOCIO,COSTO.TIPO_CCOSTO,CU.CODIGO,C.NOMBRE AS NOMBRECLIENTE ,P.NOMBRE AS NOMBREPROYECTO,T.TIPO_TIPOLOGIA,E.TIPO_EMPRESA,PR.AFECTAIVA,ST.TIPO_STATUS,P.PROBABILIDAD,P.PORCENTAJE_PROBABILIDAD,P.PLAZO,P.FECHA_INICIO,P.FECHA_TERMINO,P.FECHA_PLAZO_NEG
FROM PROYECTO P
INNER JOIN SUCURSAL_CLIENTE SC ON SC.ID = P.ID_CLIENTE_SUCURSAL
INNER JOIN CLIENTE C ON C.ID = SC.ID_CLIENTE
INNER JOIN TIPOLOGIA T ON T.ID = P.ID_TIPOLOGIA
INNER JOIN EMPRESA E ON E.ID = P.TIPO_EMPRESA
INNER JOIN CCOSTO_UNEGOCIO CU ON CU.ID = P.ID_CCOSTO_UNEGOCIO 
INNER JOIN CCOSTO COSTO ON COSTO.ID = CU.ID_CCOSTO
INNER JOIN UNEGOCIO U ON U.ID = CU.ID_UNEGOCIO
INNER JOIN PRESUPUESTO PR ON PR.ID = P.ID_PRESUPUESTO
INNER JOIN STATUS_PROYECTO ST ON ST.ID = P.STATUS_PROYECTO
WHERE (P.ID=@ID OR @ID=0 OR @ID IS NULL) AND (C.ID=@IDCLIENTE OR @IDCLIENTE = 0 OR @IDCLIENTE IS NULL) AND (P.NOMBRE=@NOMBRE OR @NOMBRE IS NULL)
AND (P.TIPO_EMPRESA=@ID_TIPOEMPRESA OR @ID_TIPOEMPRESA=0 OR @ID_TIPOEMPRESA IS NULL) AND (ST.ID=@STATUS_PROYECTO  OR @STATUS_PROYECTO=0 OR @STATUS_PROYECTO IS NULL)
AND (P.NUM_PROYECTO = @NUMPROYECTO OR @NUMPROYECTO IS NULL)
AND (P.ID_TIPOLOGIA= @IDTIPOLOGIA OR @IDTIPOLOGIA=0 OR @IDTIPOLOGIA IS NULL)
AND (U.ID=@UNIDADNEGOCIO OR @UNIDADNEGOCIO=0 OR @UNIDADNEGOCIO IS NULL)
AND (COSTO.ID=@IDCENTROCOSTO OR @IDCENTROCOSTO=0 OR @IDCENTROCOSTO IS NULL)
END;

