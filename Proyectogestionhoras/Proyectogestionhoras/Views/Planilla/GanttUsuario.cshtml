@{

    ViewData["Title"] = "Mi Gantt";

}

<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .section-header {
        text-align: center;
        font-size: 24px;
        margin-bottom: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
    }

    th, td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
    }
    td{
        font-size:12px;
        width: 40px;
        word-wrap: break-word;

    }

    th {
        background-color: #f4f4f4;
    }

    .completed {
        background-color: #4CAF50;
        color: white;
    }

    .no-hours {
        background-color: #f9f9f9;
    }

    .table-separator {
        margin-bottom: 50px;
    }

   

    .yellow-row td {
        background-color: yellow; /* Color amarillo para la fila */
    }

    .izquierda {
        text-align: left; /* Alinear texto a la izquierda */
    }
</style>

<div class="form-container">
    <h2 class="section-header">Mi Gantt</h2>
    <!-- Botón para descargar el PDF -->

    <div class="table-separator">
        <table>
            <thead>
                <tr id="headRow">
                    <th>Proyecto</th>
                </tr>
            </thead>
            <tbody id="ganttBody">
                <!-- Filas del cuerpo de la tabla -->
            </tbody>
            <tfoot>
                <tr id="totalRow">
                    <th>Totales</th>
                </tr>
            </tfoot>
        </table>
    </div>

    <div style="display:none;" class="section-content table-separator">
        <table>
            <thead>
                <tr style="background-color: #f9eb8b; color: black;">
                    <th style="text-align:center;">Nombre Proyecto</th>
                    <th style="text-align:center;">HH Realizadas</th>
                    <th style="text-align:center;">HH Restantes</th>
                    <th style="text-align:center;">Totales HH</th>
                </tr>
            </thead>
            <tbody>
                @if (ViewBag.Proyectos != null)
                {
                    @foreach (var proyecto in ViewBag.Proyectos)
                    {
                        <tr>
                            <td><strong>@proyecto.NOMBREPROYECTO</strong></td>
                            <td style="text-align:center;"><input class="hhrealizadas" type="number" readonly/></td>
                            <td style="text-align:center;"><input class="hhrestantes" type="number" value="@proyecto.HHRESTANTES" readonly/></td>
                            <td style="text-align:center;"><input type="number" class="totaleshh" readonly/></td>
                        </tr>
                    }
                }

              
            </tbody>
        </table>
    </div>
</div>

@{
    var idusuario = Context.Session.GetInt32("id");
}
<script>
    $(document).ready(function () {
        const idusuario = @Context.Session.GetInt32("id"); // Obtener el valor de idusuario desde Razor

        // Función para obtener todos los meses entre dos fechas
        function getMesesEntreFechas(fechaInicio, fechaFin) {
            const meses = [];
            const fechaActual = new Date(fechaInicio);
            const fechaFinal = new Date(fechaFin);

            while (fechaActual <= fechaFinal) {
                const mesFormateado = (fechaActual.getMonth() + 1).toString().padStart(2, '0');
                meses.push({
                    año: fechaActual.getFullYear(),
                    mes: mesFormateado
                });
                fechaActual.setMonth(fechaActual.getMonth() + 1);
            }

            return meses;
        }

        // Función para generar el encabezado de la tabla
        function generarEncabezado(mesesOrdenados) {
            const headRow = $('#headRow');
            mesesOrdenados.forEach(mes => {
                const [año, mesNum] = mes.split('-');
                const th = $('<th>').text(`${mesNum}/${año}`);
                headRow.append(th);
            });

            headRow.append($('<th>').text('Totales'));
        }

        function llenarCuerpoTabla(ganttData, mesesOrdenados) {
            const tbody = $('#ganttBody');
            const totalesPorMes = new Array(mesesOrdenados.length).fill(0); 

            ganttData.forEach(proyecto => {
   
                let totalHorasProyecto = 0;

     
                const inputRow = $(`td:contains('${proyecto.nombreProyecto}')`).closest('tr');
                const inputHHRealizadas = inputRow.find('.hhrealizadas');
                const inputHHRestantes = inputRow.find('.hhrestantes');
                const inputTotalesHH = inputRow.find('.totaleshh');

                // Calcular las horas totales del proyecto
                proyecto.horasPorMes.forEach(h => {
                    totalHorasProyecto += h.horas; // Sumar horas por mes
                });

               
                if (inputHHRealizadas.length && inputHHRestantes.length && inputTotalesHH.length) {
                    inputHHRealizadas.val(totalHorasProyecto); 
                    const hhRestantes = parseFloat(inputHHRestantes.val()) || 0;
                    const totalHH = totalHorasProyecto + hhRestantes;

                    inputTotalesHH.val(totalHH); 

      
                    const trAmarillo = $('<tr>');
                    const tdAmarillo = $('<td>')
                        .text(`Duración: ${proyecto.nombreProyecto}: ${totalHH} hrs`)
                        .attr('colspan', 1)
                        .css({
                            'background-color': 'yellow',
                            'text-align': 'left', 'word-wrap': 'break-word', // Permite que el texto se divida en varias líneas
                            'white-space': 'normal'
                        });

                    trAmarillo.append(tdAmarillo);

            
                    const mesesDuracion = getMesesEntreFechas(proyecto.fechaInicio, proyecto.fechaTermino);
                    const mesesIndices = mesesDuracion.map(m => `${m.año}-${m.mes}`);

                    mesesOrdenados.forEach((mes, index) => {
                        const tdDuracion = $('<td>');
                        if (mesesIndices.includes(mes)) {
                            tdDuracion.addClass('duracion').css('background-color', 'yellow'); // Aplicar color amarillo
                        }
                        trAmarillo.append(tdDuracion);
                    });

    
                    tbody.append(trAmarillo);
                }

                const tr = $('<tr>');
                const tdProyecto = $('<td>')
                    .text(`Hrs Ejec.: ${proyecto.nombreProyecto}`) // Nombre del proyecto
                    .css('text-align', 'left');
                tr.append(tdProyecto);

                let totalHorasFila = 0; 

                mesesOrdenados.forEach((mes, index) => {
                    const [año, mesNum] = mes.split('-');
                    const td = $('<td>');

                    const horasData = proyecto.horasPorMes.find(h => h.año == parseInt(año) && h.mes.toString().padStart(2, '0') == mesNum);
                    const horas = horasData ? horasData.horas : 0;

                    if (horas > 0) {
                        td.addClass('completed').text(`${horas} hrs`); 
                    } else {
                        td.addClass('no-hours').text('-');
                    }

                  
                    totalesPorMes[index] += horas;
                    totalHorasFila += horas;
                    tr.append(td);
                });

                const tdTotal = $('<td>').text(totalHorasFila > 0 ? `${totalHorasFila} hrs` : '-').addClass('completed');
                tr.append(tdTotal);

                tbody.append(tr);
            });

            // Llenar la fila de totales
            llenarFilaTotales(totalesPorMes);
        }

        function llenarFilaTotales(totalesPorMes) {
            const totalRow = $('#totalRow');
            totalesPorMes.forEach(total => {
                const tdTotal = $('<td>').text(total > 0 ? `${total} hrs` : '-');
                totalRow.append(tdTotal);
            });
           
            const totalGeneral = totalesPorMes.reduce((acc, curr) => acc + curr, 0);
            totalRow.append($('<td>').text(totalGeneral > 0 ? `${totalGeneral} hrs` : '-')); // Total General
        }

        $.ajax({
            url: `/Planilla/GenerarGant`,
            type: 'GET',
            data: { idusuario: idusuario },
            success: function (ganttData) {
     
                let mesesUnicos = new Set();
                ganttData.forEach(proyecto => {
                    const meses = getMesesEntreFechas(proyecto.fechaInicio, proyecto.fechaTermino);
                    meses.forEach(m => mesesUnicos.add(`${m.año}-${m.mes}`));
                });

                // Ordenar los meses únicos en orden cronológico
                const mesesOrdenados = Array.from(mesesUnicos).sort((a, b) => {
                    const [añoA, mesA] = a.split('-').map(Number);
                    const [añoB, mesB] = b.split('-').map(Number);
                    return new Date(añoA, mesA - 1) - new Date(añoB, mesB - 1);
                });

                // Generar el encabezado y llenar el cuerpo de la tabla
                generarEncabezado(mesesOrdenados);
                llenarCuerpoTabla(ganttData, mesesOrdenados);
            },
            error: function (error) {
                console.error('Error:', error);
            }
        });
    });
</script>

