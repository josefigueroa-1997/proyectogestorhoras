@{
    ViewData["Title"] = "Proyectos En Negociación";

}
<h1 class="text-2xl font-bold mb-4">Reporte de Negociación</h1>
<div class="container mx-auto mt-4 p-4 bg-white rounded-lg shadow-md">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="tablaReporte">
            <thead class="bg-blue-100">
                <tr>
                    <th class="text-left text-xs font-medium ">Probabilidad</th>
                    <th class="text-left text-xs font-medium ">Tipología</th>
                    <th class="text-left text-xs font-medium ">U. Negocio</th>
                    <th class="text-left text-xs font-medium ">Cliente</th>
                    <th class="text-left text-xs font-medium ">Num Proyecto</th>
                    <th class="text-left text-xs font-medium ">Nombre</th>
                    <th class="text-left text-xs font-medium ">C. Costo</th>

                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</div>

<script>
 
    function formatearNumero(num) {
        num = parseFloat(num).toFixed(2);
        const partes = num.split('.');
        partes[0] = partes[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        return partes.join(',');
    }

    $(document).ready(function () {
        cargarReporte();
    });

    function cargarReporte() {
        $.ajax({
            url: '/Reporte/ObtenerDatosNegociacion',
            method: 'GET',
            dataType: 'json',
            success: function (datos) {
                const tabla = $('#tablaReporte');
                const fechasUnicas = new Set();

      
                datos.forEach(item => {
                    const fecha = new Date(item.fechaFactura);
                    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                    const anio = fecha.getFullYear();
                    const mesAnio = `${mes}/${anio}`;
                    fechasUnicas.add(mesAnio);
                });

                const fechasOrdenadas = Array.from(fechasUnicas).sort((a, b) => {
                    const [mesA, anioA] = a.split('/');
                    const [mesB, anioB] = b.split('/');
                    return anioA - anioB || mesA - mesB;
                });

 
                const filaCabecera = tabla.find('thead tr');
                fechasOrdenadas.forEach(mesAnio => {
                    const th = $('<th class="text-left text-xs font-medium "></th>').text(mesAnio);
                    filaCabecera.append(th);
                });
                filaCabecera.append('<th class="text-left text-xs font-medium ">Total General</th>'); 

                const ordenProbabilidad = {
                    "Alto": 1,
                    "Medio": 2,
                    "Bajo": 3
                };

                const datosAgrupados = {};
                datos.forEach(item => {
                    const numProyecto = item.numProyecto;
                    if (!datosAgrupados[numProyecto]) {
                        datosAgrupados[numProyecto] = {
                            ...item,
                            montos: {}
                        };
                    }
                    const fecha = new Date(item.fechaFactura);
                    const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                    const anio = fecha.getFullYear();
                    const mesAnio = `${mes}/${anio}`;
                    datosAgrupados[numProyecto].montos[mesAnio] = item.neto;
                });

                const datosArray = Object.values(datosAgrupados);

                datosArray.sort((a, b) => {
                    const comparacionProbabilidad = ordenProbabilidad[a.probabilidad] - ordenProbabilidad[b.probabilidad];
                    if (comparacionProbabilidad !== 0) {
                        return comparacionProbabilidad;
                    }
                    const comparacionTipologia = a.tipoTipologia.localeCompare(b.tipoTipologia);
                    if (comparacionTipologia !== 0) {
                        return comparacionTipologia;
                    }
                    return a.unegocio.localeCompare(b.unegocio);
                });

                function crearFilaTotal(titulo, totalPorMes) {
                    const filaTotal = $('<tr class="text-left text-xs font-medium border border-black"></tr>').addClass('fila-total').html(
                        `<td class="text-left text-xs font-medium border border-black" colspan="7">Total ${titulo}</td>`
                    );

                    let totalFila = 0; 
                    fechasOrdenadas.forEach(mesAnio => {
                        const totalMes = totalPorMes[mesAnio] || 0;
                        const td = $('<td class="text-left text-xs font-medium text-right border border-black"></td>').html(`${formatearNumero(totalMes)}`); // Aplicar formateo
                        filaTotal.append(td);
                        totalFila += totalMes; 
                    });

                    filaTotal.append(`<td class="text-left text-xs font-medium text-right border border-black">${formatearNumero(totalFila)}</td>`); // Agregar total de la fila a Total General

                    return filaTotal;
                }

                let totalPorMesProbabilidad = {};
                let totalPorMesTipologia = {};
                let totalPorMesNegocio = {};
                let probabilidadActual = null;
                let tipologiaActual = null;
                let negocioActual = null;

                let totalGeneral = 0; 

                datosArray.forEach(item => {
               
                    if (tipologiaActual && (tipologiaActual !== item.tipoTipologia || probabilidadActual !== item.probabilidad)) {
                      
                        tabla.find('tbody').append(crearFilaTotal(`Unidad de Negocio ${negocioActual}`, totalPorMesNegocio));
                        tabla.find('tbody').append(crearFilaTotal(`Tipología ${tipologiaActual} (Probabilidad ${probabilidadActual})`, totalPorMesTipologia));
                        totalPorMesTipologia = {}; 
                        totalPorMesNegocio = {}; 
                    }

                
                    if (probabilidadActual && probabilidadActual !== item.probabilidad) {
                        tabla.find('tbody').append(crearFilaTotal(`Probabilidad ${probabilidadActual}`, totalPorMesProbabilidad));
                        totalPorMesProbabilidad = {};
                    }

                 
                    if (negocioActual && negocioActual !== item.unegocio) {
                        tabla.find('tbody').append(crearFilaTotal(`Unidad de Negocio ${negocioActual}`, totalPorMesNegocio));
                        totalPorMesNegocio = {};
                    }

                    probabilidadActual = item.probabilidad;
                    tipologiaActual = item.tipoTipologia;
                    negocioActual = item.unegocio;

                    const fila = $('<tr></tr>').html(
                        `<td class="text-left text-xs font-medium ">${item.probabilidad}</td>
                                    <td class="text-left text-xs font-medium ">${item.tipoTipologia}</td>
                                    <td class="text-left text-xs font-medium">${item.unegocio}</td>
                                    <td class="text-left text-xs font-medium">${item.nombreCliente}</td>
                                    <td class="text-left text-xs font-medium"> ${item.numProyecto}</td>
                                    <td class="text-left text-xs font-medium">${item.nombre}</td>
                                    <td class="text-left text-xs font-medium">${item.cCosto}</td>`
                    );

                    let totalFila = 0; 

                    fechasOrdenadas.forEach(mesAnio => {
                        const monto = item.montos[mesAnio] || 0;
                        const td = $('<td class="text-left text-xs border font-medium text-right border-black"></td>').text(formatearNumero(monto)); // Aplicar formateo
                        fila.append(td);

                      
                        totalFila += monto;
                        totalGeneral += monto; 

                      
                        if (!totalPorMesProbabilidad[mesAnio]) totalPorMesProbabilidad[mesAnio] = 0;
                        if (!totalPorMesTipologia[mesAnio]) totalPorMesTipologia[mesAnio] = 0;
                        if (!totalPorMesNegocio[mesAnio]) totalPorMesNegocio[mesAnio] = 0;

                        totalPorMesTipologia[mesAnio] = (totalPorMesTipologia[mesAnio] || 0) + monto;
                        totalPorMesProbabilidad[mesAnio] = (totalPorMesProbabilidad[mesAnio] || 0) + monto;
                        totalPorMesNegocio[mesAnio] = (totalPorMesNegocio[mesAnio] || 0) + monto;
                    });

                    fila.append(`<td class="text-left text-xs font-medium border text-right border-black">${formatearNumero(totalFila)}</td>`); // Aplicar formateo
                    tabla.find('tbody').append(fila);
                });

           
                tabla.find('tbody').append(crearFilaTotal(`Unidad de Negocio ${negocioActual}`, totalPorMesNegocio));
                tabla.find('tbody').append(crearFilaTotal(`Tipología ${tipologiaActual} (Probabilidad ${probabilidadActual})`, totalPorMesTipologia));
                tabla.find('tbody').append(crearFilaTotal(`Probabilidad ${probabilidadActual}`, totalPorMesProbabilidad));
               
     
                const filaTotalGeneral = $('<tr class="text-left text-xs font-medium text-right border border-black"></tr>').addClass('fila-total').html(
                    '<td class="text-left text-xs font-medium border border-black" colspan="7">Total General</td>'
                );

                fechasOrdenadas.forEach(mesAnio => {
                    const totalPorMes = datosArray.reduce((acumulado, item) => {
                        return acumulado + (item.montos[mesAnio] || 0);
                    }, 0);
                    filaTotalGeneral.append(`<td class="text-left text-xs font-medium text-right border border-black">${formatearNumero(totalPorMes)}</td>`); // Aplicar formateo
                });

               
                filaTotalGeneral.append(`<td class="text-left text-xs font-medium text-right border border-black">${formatearNumero(totalGeneral)}</td>`); // Aplicar formateo
                tabla.find('tbody').append(filaTotalGeneral);
            
                $('.fila-total').css('background-color', '#f2f2f2');
            },
            error: function (error) {
                console.error('Error al cargar datos:', error);
            }
        });
    }

</script>