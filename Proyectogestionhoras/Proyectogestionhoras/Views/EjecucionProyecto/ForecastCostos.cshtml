@{
    ViewData["Title"] = "Forecast Costos";
}

<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 60px;
    }

    .form-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        text-align: center;
        margin-bottom: 10px;
    }

    .form-subtitle {
        font-size: 1.0rem;
        color: #666;
        text-align: center;
        margin-bottom: 20px;
    }



    .highlight {
        background-color: #f8d7da;
        font-weight: bold;
    }

    .panel-container {
        display: flex;
        justify-content: space-between;
        gap: 0px;
        width: 100%;
        margin-top: 0;
        padding-top: 0;
    }

    .panel-item {
        flex-grow: 1;
        border: 2px solid #444;
        border-radius: 0;
        padding: 10px 20px;
        background-color: #f2f3f4;
        color: black;
        text-align: center;
        transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
    }



        .panel-item:hover {
            background-color: #fcaa67;
            color: #fff;
        }

    .alert {
        padding: 15px;
        font-size: 16px;
        font-weight: bold;
        border: 1px solid transparent;
        border-radius: 5px;
        margin-bottom: 15px;
        text-align: center;
        transition: opacity 0.3s ease-in-out;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }
</style>
@{
    int? idproyecto = Context.Session.GetInt32("numproyecto");
    int idproyectos = 0;
    decimal totalsocios = 0;
    decimal totalstaff = 0;

    decimal totalsociosproyectados = 0;
    decimal totalstaffproyectados = 0;
    decimal totalserviciosproyectados = 0;
    decimal totalgastosproyectados = 0;
    decimal totalcostosproyectados = 0;
    int idcuentasocio = 0;
    string? cuentasocio = "";
    int idcuentastaff = 0;
    string? cuentastaff = "";
    decimal totalsociosforecast = 0;
    decimal totalstaffforecast = 0;

}

<div class="form-container">
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" role="alert">
            @TempData["ErrorMessage"]
        </div>
    }
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" role="alert">
            @TempData["SuccessMessage"]
        </div>
    }
    
    
    <div class="form-group">

        @foreach (var proyecto in ViewBag.Proyecto)
        {
            idproyectos = proyecto.Id;
            <div class="panel-container flex justify-center mb-5">
                <a href="@Url.Action("ForecastIngreso","EjecucionProyecto",new{id=idproyectos})" class="panel-item bg-blue-500 text-white px-4 py-2 rounded-l hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    Forecast Ingresos del Proyecto
                </a>
                <a href="@Url.Action("FlujoCajaProyecto","EjecucionProyecto",new{id=idproyectos})" class="panel-item bg-green-500 text-white px-4 py-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">
                    Flujo de Caja del Proyecto
                </a>
                <a href="@Url.Action("SeleccionarProyecto","EjecucionProyecto",new{statusproyecto=2})" class="panel-item bg-gray-500 text-white px-4 py-2 rounded-r hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Seleccionar otro Proyecto
                </a>
            </div>
            <p class="form-subtitle" style="color:black;">Información del Proyecto</p>

            <input type="hidden" id="unidadNegocio" value="@proyecto.IDUNEGOCIO" />
            <input type="hidden" id="centroCosto" value="@proyecto.IDCOSTO" />
            <input type="hidden" id="codigo" value="@proyecto.Codigo" />
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-green-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">Número del Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Cliente</th>
                            <th class="p-2 border border-gray-300 text-left">Departamento</th>
                            <th class="p-2 border border-gray-300 text-left">Moneda</th>
                            @if (proyecto.MontoOrigenExtranjero > 0)
                            {
                                <th class="p-2 border border-gray-300 text-left">Monto Moneda Origen</th>
                            }
                            <th class="p-2 border border-gray-300 text-left">MontoCLP</th>
                            <th class="p-2 border border-gray-300 text-left">C.Costo</th>
                            <th class="p-2 border border-gray-300 text-left">Código</th>
                            <th class="p-2 border border-gray-300 text-left">Tipología</th>
                            <th class="p-2 border border-gray-300 text-left">Empresa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.numproyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreProyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreCliente</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NOMBREDEPARTAMENTO</td>
                            <td class="p-2 border border-gray-300 text-left" data-moneda="@proyecto.MONEDA">

                                @proyecto.MONEDA
                            </td>
                            @if (proyecto.MontoOrigenExtranjero > 0)
                            {
                                <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MontoOrigenExtranjero)</td>
                            }
                            <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MontoPresupuesto)</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_CCosto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Codigo</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Tipologia</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Empresa</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            totalsociosproyectados = proyecto.HHSOCIOS * @proyecto.COSTO_SOCIO;
            totalstaffproyectados = proyecto.HHSTAFF * @proyecto.COSTO_STAFF;

        }
    </div>
    <form asp-action="RegistrarCostos" asp-controller="EjecucionProyecto" method="post">
        <input type="hidden" name="idproyecto" value="@idproyecto" />

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Socios</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-1 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">SubTotal</th>
                            <th class="p-2 border border-gray-300 text-left">Reajuste</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>
                            <th class="p-2 border border-gray-300 text-left">Glosa</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {

                            @for (int i = 0; i < ViewBag.GastosHH.Count; i++)
                            {

                                var gasto = ViewBag.GastosHH[i];
                                @if (gasto.tiporecurso == "Socio")
                                {


                                    <tr>
                                        <input type="hidden" name="gastosHH[@i].Tiporecurso" value="@gasto.tiporecurso" />
                                        <input type="hidden" name="gastosHH[@i].Mes" value="@gasto.mes" />
                                        <input type="hidden" name="gastosHH[@i].Anio" value="@gasto.anio" />
                                        <input type="hidden" name="gastosHH[@i].Subtotal" value="@gasto.costorecurso" />
                                        <input type="hidden" name="gastosHH[@i].HHtotales" value="@gasto.totalhh" />

                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <input type="hidden" name="gastosHH[@i].IdGastoHH" value="@ViewBag.GastosRecursos[i].Id" />
                                            <td class="p-1 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" value="@ViewBag.GastosRecursos[i].Fechapago?.ToString("yyyy-MM-dd")" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                                            </td>
                                            if (ViewBag.GastosRecursos[i].Fechapago != null)
                                            {
                                                totalsocios += ViewBag.GastosRecursos[i]?.Monto ?? 0;
                                            }
                                            else
                                            {
                                                totalsociosforecast += ViewBag.GastosRecursos[i]?.Monto ?? 0;
                                            }
                                        }
                                        else
                                        {
                                            <td class="p-1 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                                            </td>


                                        }

                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-1">@gasto.cuenta</td>

                                        <td class="p-1 border border-gray-300 text-right w-20">@String.Format("{0:N2}", gasto.totalhh)</td>
                                        <td class="p-1 border border-gray-300 text-right w-25">@String.Format("{0:N0}", gasto.costorecurso)</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Reajuste ?? "")" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montosocio" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Monto ?? "")" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montosocio" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos != null && ViewBag.GastosRecursos.Count > i)
                                        {

                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@ViewBag.GastosRecursos[i].Observacion</textarea>
                                            </td>

                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                            </td>
                                        }



                                        @{

                                            cuentasocio = gasto.cuenta;
                                            idcuentasocio = gasto.idcuenta;
                                        }
                                    </tr>
                                }
                            }

                        }


                    </tbody>
                </table>

            </div>

        </div>
        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Otros Gastos Socios</p>
            <div class="overflow-x-auto">
                <table id="tablaGastosSocios" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-red-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoServicios</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Estado</th>

                            <th class="p-2 border border-gray-300 text-left">Glosa</th>

                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Acción</th>



                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.ServiciosEjecucion != null)
                        {
                            @foreach (var se in ViewBag.ServiciosEjecucion)
                            {
                                if (se.Tiposervicio == "Socios")
                                {
                                    <tr>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idserviciosocio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Servicios != null)
                                                {
                                                    @foreach (var servicio in ViewBag.Servicios)
                                                    {
                                                        if (servicio.Id == se.Idservicio)
                                                        {
                                                            <option value="@servicio.Id" selected>@servicio.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@servicio.Id">@servicio.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idproveedorsocio" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Proveedores != null)
                                                {
                                                    @foreach (var proveedor in ViewBag.Proveedores)
                                                    {
                                                        if (proveedor.Id == se.Idproveedor)
                                                        {
                                                            <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}", @se.Monto)" id="montoservicio" name="montoserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        <td class="p-2 border border-gray-300 text-left"><input type="date" value="@se.Fecha.ToString("yyyy-MM-dd")" name="fechaserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Estadosocio" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">


                                                @if (se.Estado == "Forecast")
                                                {
                                                    <option value="Forecast" selected>Forecast</option>
                                                }
                                                else
                                                {
                                                    <option value="Forecast">Forecast</option>
                                                }

                                                @if (se.Estado == "Pagada")
                                                {
                                                    <option value="Pagada" selected>Pagada</option>
                                                }
                                                else
                                                {
                                                    <option value="Pagada">Pagada</option>
                                                }
                                            </select>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <textarea rows="2" name="observacionserviciosocio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@se.Observacion</textarea>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                        <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                        <td style="display:none;">
                                            <input type="hidden" name="EliminarServicioSocio" class="EliminarServicioSocio" value="false" />
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <button type="button" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-700" onclick="limpiarServicioSocio(this)">Eliminar</button>
                                        </td>
                                        <td style="display:none">
                                            <input type="text" class="idsegmentoservicio" name="idsegmentoserviciosocio" />
                                        </td>
                                    </tr>
                                    <input type="hidden" name="IdServicioRealsocio" value="@se.Id" />
                                    <input type="hidden" name="Tiposerviciosocio" value="@se.Tiposervicio" />
                                }

                            }
                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idserviciosocio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idproveedorsocio" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoservicio" name="montoserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechaserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Estadosocio" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                    <option value="Forecast" selected>Forecast</option>
                                    <option value="Pagada">Pagada</option>
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observacionserviciosocio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                            <td style="display:none;">
                                <input type="hidden" name="EliminarServicioSocio" class="EliminarServicioSocio" value="false" />
                            </td>
                            <td style="display:none">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciosocio" />
                            </td>
                            <input type="hidden" name="IdServicioRealsocio" value="" />
                            <input type="hidden" name="Tiposerviciosocio" value="Socios" />

                        </tr>

                    </tbody>
                </table>
                <button id="btnAgregarGastoSocio" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Servicio</button>

            </div>

        </div>
        @*staff*@
        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Staff</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">SubTotal</th>
                            <th class="p-2 border border-gray-300 text-left">Reajuste</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>
                            <th class="p-2 border border-gray-300 text-left">Glosa</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {
                            @for (int i = 0; i < ViewBag.GastosHH.Count; i++)
                            {

                                var gasto = ViewBag.GastosHH[i];
                                @if (gasto.tiporecurso == "Staff")
                                {


                                    <tr>
                                        <input type="hidden" name="gastosHH[@i].Tiporecurso" value="@gasto.tiporecurso" />
                                        <input type="hidden" name="gastosHH[@i].Mes" value="@gasto.mes" />
                                        <input type="hidden" name="gastosHH[@i].Anio" value="@gasto.anio" />
                                        <input type="hidden" name="gastosHH[@i].Subtotal" value="@gasto.costorecurso" />
                                        <input type="hidden" name="gastosHH[@i].HHtotales" value="@gasto.totalhh" />
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <input type="hidden" name="gastosHH[@i].IdGastoHH" value="@ViewBag.GastosRecursos[i].Id" />
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" value="@ViewBag.GastosRecursos[i].Fechapago?.ToString("yyyy-MM-dd")" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                            if (ViewBag.GastosRecursos[i].Fechapago != null)
                                            {
                                                totalstaff += ViewBag.GastosRecursos[i]?.Monto ?? 0;
                                            }
                                            else
                                            {
                                                totalstaffforecast += ViewBag.GastosRecursos[i]?.Monto ?? 0;
                                            }
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                        }
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2">@gasto.cuenta</td>
                                        <td class="p-1 border border-gray-300 text-right w-20">@String.Format("{0:N2}", gasto.totalhh)</td>
                                        <td class="p-1 border border-gray-300 text-right w-25">@String.Format("{0:N0}", gasto.costorecurso)</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Reajuste ?? "")" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montostaff" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Monto ?? "")" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montostaff" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos != null && ViewBag.GastosRecursos.Count > i)
                                        {

                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@ViewBag.GastosRecursos[i].Observacion</textarea>
                                            </td>

                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                            </td>
                                        }
                                        @{

                                            idcuentastaff = gasto.idcuenta;
                                            cuentastaff = gasto.cuenta;
                                        }
                                    </tr>
                                }
                            }


                        }


                    </tbody>
                </table>

            </div>

        </div>




        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Honorarios Consultores Externos</p>
            <div class="overflow-x-auto">
                <table id="tablaHonorarios" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-orange-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoServicios</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Estado</th>

                            <th class="p-2 border border-gray-300 text-left">Glosa</th>

                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Acción</th>



                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.ServiciosEjecucion != null)
                        {
                            @foreach (var se in ViewBag.ServiciosEjecucion)
                            {
                                if (se.Tiposervicio == "Consultores Externos")
                                {
                                    <tr>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idserviciohonorario" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Servicios != null)
                                                {
                                                    @foreach (var servicio in ViewBag.Servicios)
                                                    {
                                                        if (servicio.Id == se.Idservicio)
                                                        {
                                                            <option value="@servicio.Id" selected>@servicio.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@servicio.Id">@servicio.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idproveedorhonorario" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Proveedores != null)
                                                {
                                                    @foreach (var proveedor in ViewBag.Proveedores)
                                                    {
                                                        if (proveedor.Id == se.Idproveedor)
                                                        {
                                                            <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}", @se.Monto)" id="montoservicio" name="montoserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        <td class="p-2 border border-gray-300 text-left"><input type="date" value="@se.Fecha.ToString("yyyy-MM-dd")" name="fechaserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Estadohonorario" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">


                                                @if (se.Estado == "Forecast")
                                                {
                                                    <option value="Forecast" selected>Forecast</option>
                                                }
                                                else
                                                {
                                                    <option value="Forecast">Forecast</option>
                                                }

                                                @if (se.Estado == "Pagada")
                                                {
                                                    <option value="Pagada" selected>Pagada</option>
                                                }
                                                else
                                                {
                                                    <option value="Pagada">Pagada</option>
                                                }
                                            </select>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <textarea rows="2" name="observacionserviciohonorario" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@se.Observacion</textarea>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                        <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                        <td style="display:none;">
                                            <input type="hidden" name="EliminarServicioHonorario" class="EliminarServicioHonorario" value="false" />
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <button type="button" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-700" onclick="limpiarServicioHonorario(this)">Eliminar</button>
                                        </td>
                                        <td style="display:none">
                                            <input type="text" class="idsegmentoservicio" name="idsegmentoserviciohonorario" />
                                        </td>
                                    </tr>
                                    <input type="hidden" name="IdServicioRealhonorario" value="@se.Id" />
                                    <input type="hidden" name="Tiposerviciohonorario" value="@se.Tiposervicio" />
                                }

                            }
                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idserviciohonorario" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idproveedorhonorario" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoservicio" name="montoserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechaserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Estadohonorario" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                    <option value="Forecast" selected>Forecast</option>
                                    <option value="Pagada">Pagada</option>
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observacionserviciohonorario" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                            <td style="display:none;">
                                <input type="hidden" name="EliminarServicioHonorario" class="EliminarServicioHonorario" value="false" />
                            </td>
                            <td style="display:none">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciohonorario" />
                            </td>
                            <input type="hidden" name="IdServicioRealhonorario" value="" />
                            <input type="hidden" name="Tiposerviciohonorario" value="Consultores Externos" />

                        </tr>

                    </tbody>
                </table>
                <button id="btnAgregarHonorario" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Servicio</button>

            </div>

        </div>
        @*SERVICIOS*@


        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Servicios </p>
            <div class="overflow-x-auto">
                <table id="tablaServicios" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-red-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoServicios</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Estado</th>

                            <th class="p-2 border border-gray-300 text-left">Glosa</th>

                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Acción</th>



                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.ServiciosEjecucion != null)
                        {
                            @foreach (var se in ViewBag.ServiciosEjecucion)
                            {
                                if (se.Tiposervicio == "Otros")
                                {
                                    <tr>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Servicios != null)
                                                {
                                                    @foreach (var servicio in ViewBag.Servicios)
                                                    {
                                                        if (servicio.Id == se.Idservicio)
                                                        {
                                                            <option value="@servicio.Id" selected>@servicio.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@servicio.Id">@servicio.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                <option value="" disabled selected>Seleccione un Servicio</option>
                                                @if (ViewBag.Proveedores != null)
                                                {
                                                    @foreach (var proveedor in ViewBag.Proveedores)
                                                    {
                                                        if (proveedor.Id == se.Idproveedor)
                                                        {
                                                            <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                        }
                                                        else
                                                        {
                                                            <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                        }
                                                    }
                                                }
                                            </select>

                                        </td>
                                        <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}", @se.Monto)" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        <td class="p-2 border border-gray-300 text-left"><input type="date" value="@se.Fecha.ToString("yyyy-MM-dd")" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <select name="Estado" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">


                                                @if (se.Estado == "Forecast")
                                                {
                                                    <option value="Forecast" selected>Forecast</option>
                                                }
                                                else
                                                {
                                                    <option value="Forecast">Forecast</option>
                                                }

                                                @if (se.Estado == "Pagada")
                                                {
                                                    <option value="Pagada" selected>Pagada</option>
                                                }
                                                else
                                                {
                                                    <option value="Pagada">Pagada</option>
                                                }
                                            </select>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@se.Observacion</textarea>
                                        </td>
                                        <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                        <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                        <td style="display:none;">
                                            <input type="hidden" name="EliminarServicioOtro" class="EliminarServicioOtro" value="false" />
                                        </td>
                                        <td class="p-2 border border-gray-300 text-left">
                                            <button type="button" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-700" onclick="limpiarServicioOtro(this)">Eliminar</button>
                                        </td>
                                        <td style="display:none;">
                                            <input type="text" class="idsegmentoservicio" name="idsegmentoserviciootro" />
                                        </td>
                                    </tr>
                                    <input type="hidden" name="IdServicioReal" value="@se.Id" />
                                    <input type="hidden" name="Tiposervicio" value="@se.Tiposervicio" />
                                }

                            }
                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="Estado" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                    <option value="Forecast" selected>Forecast</option>
                                    <option value="Pagada">Pagada</option>
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                            <td style="display:none;">
                                <input type="hidden" name="EliminarServicioOtro" class="EliminarServicioOtro" value="false" />
                            </td>
                            <td style="display:none;">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciootro" />
                            </td>
                            <input type="hidden" name="IdServicioReal" value="" />
                            <input type="hidden" name="Tiposervicio" value="Otros" />

                        </tr>

                    </tbody>
                </table>
                <button id="btnAgregarServicio" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Servicio</button>
            </div>

        </div>

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos </p>
            <div class="overflow-x-auto">
                <table id="tablagastos" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-yellow-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoGasto</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Estado</th>
                            <th class="p-2 border border-gray-300 text-left">Glosa</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Acción</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosEjecucion != null)
                        {
                            @foreach (var ge in ViewBag.GastosEjecucion)
                            {
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            @if (ViewBag.Gastos != null)
                                            {
                                                @foreach (var gasto in ViewBag.Gastos)
                                                {
                                                    if (gasto.Id == ge.IdGasto)
                                                    {
                                                        <option value="@gasto.Id" selected>@gasto.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@gasto.Id">@gasto.Nombre</option>
                                                    }
                                                }
                                            }

                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            @if (ViewBag.ProGastos != null)
                                            {
                                                @foreach (var proveedor in ViewBag.ProGastos)
                                                {
                                                    if (proveedor.Id == ge.IdProveedor)
                                                    {
                                                        <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" value="@String.Format("{0:N0}", @ge.Monto)" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" value="@ge.Fecha.ToString("yyyy-MM-dd")" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="EstadoGasto" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">


                                            @if (ge.Estado == "Forecast")
                                            {
                                                <option value="Forecast" selected>Forecast</option>
                                            }
                                            else
                                            {
                                                <option value="Forecast">Forecast</option>
                                            }

                                            @if (ge.Estado == "Pagada")
                                            {
                                                <option value="Pagada" selected>Pagada</option>
                                            }
                                            else
                                            {
                                                <option value="Pagada">Pagada</option>
                                            }
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@ge.Observacion</textarea>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                                    <td style="display:none;">
                                        <input type="hidden" name="esEliminados" class="esEliminados" value="false" />
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <button type="button" class="bg-red-500 text-white font-bold py-2 px-4 rounded hover:bg-red-700" onclick="limpiarFilagasto(this)">Eliminar</button>
                                    </td>
                                    <td style="display:none">
                                        <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                                    </td>
                                </tr>
                                <input type="hidden" name="IdGastoReal" value="@ge.IdGastosReal" />


                            }




                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>

                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="EstadoGasto" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                    <option value="Forecast" selected>Forecast</option>
                                    <option value="Pagada">Pagada</option>
                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                            <td style="display:none;">
                                <input type="hidden" name="esEliminados" class="esEliminados" value="false" />
                            </td>
                            <td style="display:none">
                                <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                            </td>
                            <td style="display:none;">
                                <input type="hidden" name="IdGastoReal" value="" />
                            </td>




                        </tr>

                    </tbody>
                </table>
                <td>
                    <button id="agregarFilaGastos" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Gasto</button>
                </td>
            </div>

        </div>
        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Resumen Costos del proyecto </p>
            <div class="flex justify-center py-5">
                <div class="overflow-x-auto w-full">
                    <table id="tablaresumen" class="min-w-full text-xs border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-red-400 text-black">
                                <th class="p-2 border border-gray-300 text-left min-w-[150px]">Tipo</th>
                                <th class="p-2 border border-gray-300 text-left min-w-[100px]">IdCuenta</th>
                                <th class="p-2 border border-gray-300 text-left min-w-[150px]">Cuenta Contable</th>
                                <th class="p-2 border border-gray-300 text-center min-w-[150px]">Total Proyectado</th>
                                <th class="p-2 border border-gray-300 text-center min-w-[150px]">Total Real</th>
                                <th class="p-2 border border-gray-300 text-center min-w-[150px]">Total Forecast</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 border border-gray-300 text-left">HH Socios</td>
                                @if (idcuentasocio > 0)
                                {
                                    <td class="p-2 border border-gray-300 text-left">@idcuentasocio</td>
                                }
                                else
                                {
                                    <td class="p-2 border border-gray-300 text-left"></td>
                                }

                                <td class="p-2 border border-gray-300 text-left">@cuentasocio</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalsociosproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right" id="totalSocios">@String.Format("{0:N0}", totalsocios)</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalsociosforecast)</td>
                            </tr>
                            <tr>
                                <td class="p-2 border border-gray-300 text-left">HH Staff</td>
                                @if (idcuentastaff > 0)
                                {
                                    <td class="p-2 border border-gray-300 text-left">@idcuentastaff</td>
                                }
                                else
                                {
                                    <td class="p-2 border border-gray-300 text-left"></td>
                                }

                                <td class="p-2 border border-gray-300 text-left">@cuentastaff</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalstaffproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right" id="totalStaff">@String.Format("{0:N0}", totalstaff)</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalstaffforecast)</td>
                            </tr>

                            @{
                                decimal totalforecastservicio = 0;
                                decimal totalforecastgasto = 0;
                            }
                            @foreach (var servicio in ViewBag.ServiciosProyectos)
                            {
                                decimal totaleservicioPagado = 0;
                                decimal totaleservicioForecast = 0;
                                if (ViewBag.ServiciosTotalesPagados.ContainsKey(servicio.IDSERVICIO))
                                {
                                    totaleservicioPagado = ViewBag.ServiciosTotalesPagados[servicio.IDSERVICIO];
                                }
                                if (ViewBag.ServiciosTotalesForecast.ContainsKey(servicio.IDSERVICIO))
                                {
                                    totaleservicioForecast = ViewBag.ServiciosTotalesForecast[servicio.IDSERVICIO];
                                }
                                <tr data-id="@servicio.IDSERVICIO">
                                    <td class="p-2 border border-gray-300 text-left">@servicio.NOMBRESERVICIO</td>
                                    <td class="p-2 border border-gray-300 text-left">@servicio.IDCUENTA</td>
                                    <td class="p-2 border border-gray-300 text-left">@servicio.CUENTA</td>
                                    <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @servicio.MONTO)</td>
                                    <td class="p-2 border border-gray-300 text-right total-row">@String.Format("{0:N0}", @totaleservicioPagado)</td>
                                    <td class="p-2 border border-gray-300 text-right ">@String.Format("{0:N0}", totaleservicioForecast)</td>
                                </tr>
                                totalserviciosproyectados += servicio.MONTO;
                                totalforecastservicio += totaleservicioForecast;
                            }
                            @foreach (var gasto in ViewBag.GastosProyectos)
                            {
                                decimal totalesgastopagados = 0;
                                decimal totalesgastoforecast = 0;
                                if (ViewBag.GastosTotalesPagados.ContainsKey(gasto.IDGASTOS))
                                {
                                    totalesgastopagados = ViewBag.GastosTotalesPagados[gasto.IDGASTOS];
                                }
                                if (ViewBag.GastosTotalesForecast.ContainsKey(gasto.IDGASTOS))
                                {
                                    totalesgastoforecast = ViewBag.GastosTotalesForecast[gasto.IDGASTOS];
                                }
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.NOMBREGASTO</td>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.IDCUENTA</td>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.CUENTA</td>
                                    <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.MONTO)</td>
                                    <td class="p-2 border border-gray-300 text-right" id="totalGastos_@gasto.IDGASTOS">@String.Format("{0:N0}", @totalesgastopagados)</td>
                                    <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @totalesgastoforecast)</td>
                                </tr>
                                totalgastosproyectados += gasto.MONTO;
                                totalforecastgasto += totalesgastoforecast;
                            }

                            <tr>
                                @{
                                    totalcostosproyectados = totalsociosproyectados + totalstaffproyectados + totalserviciosproyectados + totalgastosproyectados;
                                    decimal totalcostosforecast = totalforecastgasto + totalforecastservicio + totalsociosforecast + totalstaffforecast;
                                }
                                <td colspan="3" class="p-2 border border-gray-300 text-left font-bold">Totales</td>

                                <td class="p-2 border border-gray-300 text-right font-bold">@String.Format("{0:N0}", totalcostosproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right font-bold" id="totalCostos">0</td>
                                <td class="p-2 border border-gray-300 text-right font-bold">@String.Format("{0:N0}", totalcostosforecast)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


        </div>
        <div class="text-center mt-2">
            <button type="submit" class="bg-green-500 text-white p-3 text-xl w-52 h-12  rounded">Guardar Costos</button>
        </div>



    </form>
    <div class="form-group">

        <p class="form-subtitle" style="color:black;">Resumen Forecast Proveedores del proyecto </p>
        <div class="flex justify-center py-5">
            <div class="overflow-x-auto w-full">
                <table id="tablaforecastproveedor" class="min-w-full text-xs border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-green-100 text-black">
                            <th class="p-2 border border-gray-300 text-left min-w-[150px]">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left min-w-[100px]">Cuenta</th>
                            <th class="p-2 border border-gray-300 text-left min-w-[150px]">Nombre</th>
                            <th class="p-2 border border-gray-300 text-center min-w-[150px]">fecha</th>

                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>


    </div>
</div>


<script>


    /*SERVICIOS */

    $(document).ready(function () {

        $('.serviciosSelect').each(function () {
            var $select = $(this);
            var $row = $select.closest('tr');


            var selectedOption = $select.find('option:selected').val();
            if (selectedOption) {

                const idUnidadNegocio = $("#unidadNegocio").val();
                const idCentroCosto = $("#centroCosto").val();
                var nombreservicio = $(this).find('option:selected').val();


                $.ajax({
                    url: '/Proyecto/GetValoresServiciosEdicion',
                    type: 'GET',
                    data: {
                        idcosto: idCentroCosto,
                        unegocio: idUnidadNegocio,
                        idservicio: nombreservicio
                    },
                    success: function (data) {
                        const $button = $('.bg-green-500');
                        if (data && data.length > 0) {
                            
                            $row.find('.idcuentaservicio').val(data[0].idcuenta);
                            $row.find('.cuentaservicio').val(data[0].cuenta);
                            $row.find('.idsegmentoservicio').val(data[0].idsegmento);
                            $button.prop('disabled', false);
                        } else {
                            alert("No existe una cuenta o segmento enlazado a este servicio.");
                            $row.find('.idcuentaservicio').val('');
                            $row.find('.cuentaservicio').val('');
                            $row.find('.idsegmentoservicio').val('');
                            $button.prop('disabled', true);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", error);
                    }
                });
            }
        });
    });


    $(document).on('change', '.serviciosSelect', function () {
        var $row = $(this).closest('tr');
        const idUnidadNegocio = $("#unidadNegocio").val();
        const idCentroCosto = $("#centroCosto").val();
        var nombreservicio = $(this).find('option:selected').val();
        console.log(idUnidadNegocio);
        console.log(idCentroCosto);
        console.log(nombreservicio);
        $.ajax({
            url: '/Proyecto/GetValoresServiciosEdicion',
            type: 'GET',
            data: {
                idcosto: idCentroCosto,
                unegocio: idUnidadNegocio,
                idservicio: nombreservicio
            },
            success: function (data) {
                const $button = $('.bg-green-500');
                if (data && data.length > 0) {


                    $row.find('.idcuentaservicio').val(data[0].idcuenta);
                    $row.find('.cuentaservicio').val(data[0].cuenta);
                    $row.find('.idsegmentoservicio').val(data[0].idsegmento);
                    $button.prop('disabled', false);

                } else {
                    alert("No existe una cuenta o segmento enlazado a este servicio.");
                    $row.find('.idcuentaservicio').val('');
                    $row.find('.cuentaservicio').val('');
                    $row.find('.idsegmentoservicio').val('');
                    $button.prop('disabled', true);
                }
            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
    });





    function cargarServicios(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/Proyecto/ObtenerServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Servicio</option>');

                $.each(data, function (index, servicio) {
                    $(selectElement).append('<option value="' + servicio.id + '">' + servicio.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los servicios.');
            }
        });
    }


    $(document).ready(function () {
        $('.serviciosSelect').each(function () {
            cargarServicios(this);
        });
        $('.proveedorSelect').each(function () {
            cargarProveedoresServicios(this);
        });
    });

    function cargarProveedoresServicios(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }

    /*FORMATEAR MONTOS SERVICIOS Y GASTOS*/
    document.addEventListener('DOMContentLoaded', function () {

        function formatCurrency(event) {
            let value = event.target.value;


            value = value.replace(/[^\d-]/g, '');


            if (value.includes('-') && value.indexOf('-') > 0) {
                value = '-' + value.replace(/-/g, '');
            }

            if (value !== '' && value !== '-') {
                const isNegative = value.startsWith('-');
                value = value.replace(/-/g, '');


                let formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');


                if (isNegative) {
                    formattedValue = '-' + formattedValue;
                }

                event.target.value = formattedValue;
            } else {
                event.target.value = value;
            }

            updateMonto(event.target);
            updateTotal();
        }



        function removePoints(event) {
            let value = event.target.value;


            value = value.replace(/\./g, '');
            event.target.value = value;
        }

        function updateMonto(reajusteInput) {
            const row = reajusteInput.closest('tr');
            const reajusteValue = parseCurrency(reajusteInput.value);
            const subtotalValue = parseCurrency(row.querySelector('input[name*="Subtotal"]').value);
            const montoInput = row.querySelector('input[name*="Monto"]');

            const total = reajusteValue + subtotalValue;
            montoInput.value = total.toLocaleString('es-CL');
        }

        const reajusteInputs = document.querySelectorAll('input[name*="Reajuste"]');

        reajusteInputs.forEach(input => {
            input.addEventListener('input', formatCurrency);
        });

        function parseCurrency(value) {
            return parseInt(value.replace(/\./g, ''), 10) || 0;
        }


        function updateTotal() {
            let totalservicio = 0;
            let totalgasto = 0;
            let totalsocio = 0;
            let totalstaff = 0;

            let totalCostos = 0;
            const montogastoRows = document.querySelectorAll('tr');

            const montoInputs = document.querySelectorAll('input[name*="montoservicio"]');
            const montogastosocioInputs = document.querySelectorAll('input[name*="montoserviciosocio"]');
            const montohonorarioInputs = document.querySelectorAll('input[name*="montoserviciohonorario"]');
            const montoSocioInputs = document.querySelectorAll('input[id*="montosocio"]');
            const montoStaffInputs = document.querySelectorAll('input[id*="montostaff"]');



            montoInputs.forEach(input => {
                const estadoSelect = input.closest('tr').querySelector('select[name="Estado"]');
                if (estadoSelect && estadoSelect.value === "Pagada") {
                    totalservicio += parseCurrency(input.value);
                }
            });
            montogastosocioInputs.forEach(input => {
                const estadoSelect = input.closest('tr').querySelector('select[name="Estadosocio"]');
                if (estadoSelect && estadoSelect.value === "Pagada") {
                    totalservicio += parseCurrency(input.value);
                }
            });
            montohonorarioInputs.forEach(input => {
                const estadoSelect = input.closest('tr').querySelector('select[name="Estadohonorario"]');
                if (estadoSelect && estadoSelect.value === "Pagada") {
                    totalservicio += parseCurrency(input.value);
                }
            });
            montogastoRows.forEach(row => {
                const montoInput = row.querySelector('input[name="montogasto"]');
                const estadoSelect = row.querySelector('select[name="EstadoGasto"]');

                if (estadoSelect && estadoSelect.value === "Pagada") {
                    totalgasto += parseCurrency(montoInput.value);
                }
            });




            const totalSocios = parseCurrency(document.getElementById('totalSocios').textContent);
            const totalStaff = parseCurrency(document.getElementById('totalStaff').textContent);



            totalCostos = totalSocios + totalStaff + totalservicio + totalgasto;


            document.getElementById('totalCostos').textContent = totalCostos.toLocaleString('es-CL');
        }


        function cleanInputsOnSubmit(event) {

            const inputs = event.target.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"], input[name*="Reajuste"], input[name*="Monto"]');

            inputs.forEach(input => {

                let value = input.value;
                value = value.replace(/\./g, '');
                input.value = value;
            });
        }







        const montoInputs = document.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"],input[name*="Reajuste"],input[name*="montoserviciosocio"],input[name*="montoserviciohonorario"]');


        montoInputs.forEach(input => {
            input.addEventListener('input', formatCurrency);
        });


        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', cleanInputsOnSubmit);
        }
        document.getElementById("btnAgregarServicio").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montoservicio"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });
        document.getElementById("btnAgregarGastoSocio").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montoserviciosocio"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });
        document.getElementById("btnAgregarHonorario").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montoserviciohonorario"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });
        document.getElementById("agregarFilaGastos").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montogasto"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });

        updateTotal();
    });

    /*NUEVAS FILAS TABLA SERVICIO*/
    var servicios = [];
    var proveedores = [];

    function cargarDatosIniciales() {
        $.ajax({
            url: '/Proyecto/ObtenerServicios',
            type: 'GET',
            success: function (data) {
                servicios = data;
            },
            error: function () {
                alert('Ocurrió un error al cargar los servicios.');
            }
        });

        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresServicios',
            type: 'GET',
            success: function (data) {
                proveedores = data;
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedores.');
            }
        });
    }

    function rellenarSelectServicios(selectElement) {
        $(selectElement).empty();
        $(selectElement).append('<option value="" disabled selected>Seleccione un Servicio</option>');
        $.each(servicios, function (index, servicio) {
            $(selectElement).append('<option value="' + servicio.id + '">' + servicio.nombre + '</option>');
        });
    }

    function rellenarSelectProveedores(selectElement) {
        $(selectElement).empty();
        $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');
        $.each(proveedores, function (index, proveedor) {
            $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
        });
    }

    $(document).ready(function () {
        cargarDatosIniciales();

        $('.serviciosSelect').each(function () {
            rellenarSelectServicios(this);
        });
        $('.proveedorSelect').each(function () {
            rellenarSelectProveedores(this);
        });

        $('#btnAgregarServicio').on('click', function (e) {
            e.preventDefault();

            var nuevaFila = `
                        <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select  name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select  name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                        </select>
                                    </td>
                                        <td class="p-2 border border-gray-300 text-right"><input  type="text" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        <td class="p-2 border border-gray-300 text-left"><input  type="date" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                             <td class="p-2 border border-gray-300 text-left">
                                            <select name="Estado" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                                <option value="Forecast" selected>Forecast</option>
                                                <option value="Pagada">Pagada</option>
                                            </select>
                                        </td>
                                            <td class="p-2 border border-gray-300 text-left">
                                            <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                        </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly/></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly/></td>
                                         <td style="display:none;">
                                                <input type="hidden" name="EliminarServicioOtro" class="EliminarServicioOtro" value="false" />
                                            </td>
                                       <td style="display:none">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciootro" />
                            </td>
                                        <input type="hidden" name="IdServicioReal" value="" />
                                            <input type="hidden" name="Tiposervicio" value="Otros" />

                                </tr>
                `;

            $('#tablaServicios tbody').append(nuevaFila);

            var lastRow = $('#tablaServicios tbody tr:last');
            rellenarSelectServicios(lastRow.find('.serviciosSelect'));
            rellenarSelectProveedores(lastRow.find('.proveedorSelect'));
        });
    });

    /*agregar gasto socio*/
    $(document).ready(function () {
        cargarDatosIniciales();

        $('.serviciosSelect').each(function () {
            rellenarSelectServicios(this);
        });
        $('.proveedorSelect').each(function () {
            rellenarSelectProveedores(this);
        });

        $('#btnAgregarGastoSocio').on('click', function (e) {
            e.preventDefault();

            var nuevaFila = `
                               <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idserviciosocio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idproveedorsocio" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoservicio" name="montoserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechaserviciosocio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Estadosocio" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                            <option value="Forecast" selected>Forecast</option>
                                            <option value="Pagada">Pagada</option>
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observacionserviciosocio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                        <td style="display:none;">
                                                <input type="hidden" name="EliminarServicioSocio" class="EliminarServicioSocio" value="false" />
                                            </td>
                                    <td style="display:none">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciosocio" />
                            </td>
                                    <input type="hidden" name="IdServicioRealsocio" value="" />
                                    <input type="hidden" name="Tiposerviciosocio" value="Socios" />

                                </tr>
                    `;

            $('#tablaGastosSocios tbody').append(nuevaFila);

            var lastRow = $('#tablaGastosSocios tbody tr:last');
            rellenarSelectServicios(lastRow.find('.serviciosSelect'));
            rellenarSelectProveedores(lastRow.find('.proveedorSelect'));
        });
    });
    /*honorarios externos */
    $(document).ready(function () {
        cargarDatosIniciales();

        $('.serviciosSelect').each(function () {
            rellenarSelectServicios(this);
        });
        $('.proveedorSelect').each(function () {
            rellenarSelectProveedores(this);
        });

        $('#btnAgregarHonorario').on('click', function (e) {
            e.preventDefault();

            var nuevaFila = `
                                   <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idserviciohonorario" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idproveedorhonorario" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoservicio" name="montoserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechaserviciohonorario" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Estadohonorario" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                            <option value="Forecast" selected>Forecast</option>
                                            <option value="Pagada">Pagada</option>
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observacionserviciohonorario" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                        <td style="display:none;">
                                    <input type="hidden" name="EliminarServicioHonorario" class="EliminarServicioHonorario" value="false" />
                                </td>
                                      <td style="display:none">
                                <input type="text" class="idsegmentoservicio" name="idsegmentoserviciohonorario" />
                            </td>
                                    <input type="hidden" name="IdServicioRealhonorario" value="" />
                                    <input type="hidden" name="Tiposerviciohonorario" value="Consultores Externos" />

                                </tr>
                        `;

            $('#tablaHonorarios tbody').append(nuevaFila);

            var lastRow = $('#tablaHonorarios tbody tr:last');
            rellenarSelectServicios(lastRow.find('.serviciosSelect'));
            rellenarSelectProveedores(lastRow.find('.proveedorSelect'));
        });
    });
    /*GASTOS*/
    $(document).ready(function () {

        $('.gastosSelect').each(function () {
            var $select = $(this);
            var $row = $select.closest('tr');


            var selectedOption = $select.find('option:selected').val();
            if (selectedOption) {

                const idUnidadNegocio = $("#unidadNegocio").val();
                const idCentroCosto = $("#centroCosto").val();
                var nombreGasto = $select.find('option:selected').val();

                $.ajax({
                    url: '/Proyecto/GetValoresGastosEdicion',
                    type: 'GET',
                    data: {
                        idcosto: idCentroCosto,
                        unegocio: idUnidadNegocio,
                        idgasto: nombreGasto
                    },
                    success: function (data) {
                        const $button = $('.bg-green-500');
                        if (data && data.length > 0) {
                            $row.find('.segmentogastos').val(data[0].nombre);
                            $row.find('.idcuentagastos').val(data[0].idcuenta);
                            $row.find('.cuentagastos').val(data[0].cuenta);
                            $row.find('.idsegmentogasto').val(data[0].idsegmento);
                            $button.prop('disabled', false);
                        } else {
                            alert("No existe una cuenta o segmento enlazado a este gasto.");
                            $row.find('.segmentogastos').val('');
                            $row.find('.idcuentagastos').val('');
                            $row.find('.cuentagastos').val('');
                            $row.find('.idsegmentogasto').val('');
                            $button.prop('disabled', true);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", error);
                    }
                });
            }
        });
    });

    $(document).on('change', '.gastosSelect', function () {
        var $row = $(this).closest('tr');
        const idUnidadNegocio = $("#unidadNegocio").val();
        const idCentroCosto = $("#centroCosto").val();
        var nombreGasto = $(this).find('option:selected').val();

        $.ajax({
            url: '/Proyecto/GetValoresGastosEdicion',
            type: 'GET',
            data: {
                idcosto: idCentroCosto,
                unegocio: idUnidadNegocio,
                idgasto: nombreGasto
            },
            success: function (data) {
                const $button = $('.bg-green-500');
                if (data && data.length > 0) {

                    $row.find('.segmentogastos').val(data[0].nombre);
                    $row.find('.idcuentagastos').val(data[0].idcuenta);
                    $row.find('.cuentagastos').val(data[0].cuenta);
                    $row.find('.idsegmentogasto').val(data[0].idsegmento);
                    $button.prop('disabled', false);
                } else {
                    alert("No existe una cuenta o segmento enlazado a este gasto.");
                    $row.find('.segmentogastos').val('');
                    $row.find('.idcuentagastos').val('');
                    $row.find('.cuentagastos').val('');
                    $row.find('.idsegmentogasto').val('');
                    $button.prop('disabled', true);
                }
            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
    });

    function cargarGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/Proyecto/ObtenerGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un gasto</option>');


                $.each(data, function (index, gasto) {
                    $(selectElement).append('<option value="' + gasto.id + '">' + gasto.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los gastos.');
            }
        });
    }

    function cargarProveedoresGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }


    $(document).ready(function () {

        $('.gastosSelect').each(function () {
            cargarGastos(this);
        });
        $('.proveedorGastosSelect').each(function () {
            cargarProveedoresGastos(this);
        });


        $('#agregarFilaGastos').on('click', function (e) {
            e.preventDefault();


            var nuevaFila = `
                    <tr>
                        <td class="p-2 border border-gray-300 text-left">
                            <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="" disabled selected>Seleccione un gasto</option>
                            </select>
                        </td>
                        <td class="p-2 border border-gray-300 text-left">
                             <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="" disabled selected>Seleccione un proveedor</option>
                            </select>
                        </td>
                        <td class="p-2 border border-gray-300 text-right">
                            <input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                        </td>
                        <td class="p-2 border border-gray-300 text-left">
                            <input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                        </td>
                             <td class="p-2 border border-gray-300 text-left">
                                        <select name="EstadoGasto" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 ">
                                            <option value="Forecast" selected>Forecast</option>
                                            <option value="Pagada">Pagada</option>
                                        </select>
                                    </td>
                             <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                    </td>
                        <td class="p-2 border border-gray-300 text-right">
                            <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly />
                        </td>
                        <td class="p-2 border border-gray-300 text-left">
                            <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly />
                        </td>
                            <td style="display:none;">
                                            <input type="hidden" name="esEliminados" class="esEliminados" value="false" />
                                        </td>
                        <td style="display:none">
                            <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                        </td>
                        <td style="display:none;">
                            <input type="hidden" name="IdGastoReal" value="" />
                        </td>
                    </tr>
                `;


            $('#tablagastos tbody').append(nuevaFila);


            $('#tablagastos tbody tr:last .gastosSelect').each(function () {
                cargarGastos(this);
            });
            $('#tablagastos tbody tr:last .proveedorGastosSelect').each(function () {
                cargarProveedoresGastos(this);
            });
        });
    });
    /*Eliminar Servicio Otro*/
    function limpiarServicioOtro(button) {
        var fila = button.closest('tr');


        var esEliminado = fila.querySelector('input.EliminarServicioOtro');
        if (esEliminado) {
            esEliminado.value = 'true';
        }

        fila.style.display = 'none';
    }
    /*Eliminar Servicio Honorario*/
    function limpiarServicioHonorario(button){

        var fila = button.closest('tr');


        var esEliminado = fila.querySelector('input.EliminarServicioHonorario');
        if (esEliminado) {
            esEliminado.value = 'true';
        }

        fila.style.display = 'none';
    
    
    }
    /*Eliminar Servicio Socio*/
    function limpiarServicioSocio(button) {

        var fila = button.closest('tr');


        var esEliminado = fila.querySelector('input.EliminarServicioSocio');
        if (esEliminado) {
            esEliminado.value = 'true';
        }

        fila.style.display = 'none';


    }
    /*Eliminar Gasto*/ 
    function limpiarFilagasto(button) {
        var fila = button.closest('tr');


        var esEliminado = fila.querySelector('input.esEliminados');
        if (esEliminado) {
            esEliminado.value = 'true';
        }

        fila.style.display = 'none';

    }


    /*forecast proveedores*/ 
    $(document).ready(function () {

        var idproyecto = '@Context.Session.GetInt32("numproyecto")';


        $.ajax({
            url: '/EjecucionProyecto/RecuperarForecastProveedores',
            type: 'GET',
            data: { idproyecto: idproyecto },
            success: function (data) {
                renderizarTabla(data);
            },
            error: function (err) {
                console.error('Error al recuperar los datos:', err);
            }
        });

        function renderizarTabla(data) {
            const tabla = $('#tablaforecastproveedor');
            const tablaBody = tabla.find('tbody');
            const tablaHead = tabla.find('thead');


            tablaBody.empty();
            tablaHead.empty();


            const mesesUnicos = [...new Set(data.map(item => `${item.mes.toString().padStart(2, '0')}-${item.anio}`))]
                .sort((a, b) => {
                    const [mesA, anioA] = a.split('-').map(Number);
                    const [mesB, anioB] = b.split('-').map(Number);
                    const fechaA = new Date(anioA, mesA - 1); 
                    const fechaB = new Date(anioB, mesB - 1);
                    return fechaA - fechaB; 
                });


            let encabezado = `
                        <tr class="bg-green-100 text-black">
                        <th class="p-2 border border-gray-300 text-left min-w-[150px]">Proveedor</th>
                        <th class="p-2 border border-gray-300 text-left min-w-[100px]">Cuenta</th>
                        <th class="p-2 border border-gray-300 text-left min-w-[150px]">Nombre</th>`;
            mesesUnicos.forEach(mes => {
                encabezado += `<th class="p-2 border border-gray-300 text-center">${mes}</th>`;
            });
            encabezado += `<th class="p-2 border border-gray-300 text-right">Total Proveedores</th>`;
            encabezado += `</tr>`;
            tablaHead.append(encabezado);


            const totalesPorMes = new Array(mesesUnicos.length).fill(0);
            let totalGeneral = 0;


            const agrupados = agruparPor(data, ['nombreproveedor', 'cuenta', 'nombre']);

            for (let [key, registros] of Object.entries(agrupados)) {
                const [proveedor, cuenta, nombre] = key.split('|');


                let fila = `
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">${proveedor}</td>
                            <td class="p-2 border border-gray-300 text-left">${cuenta}</td>
                            <td class="p-2 border border-gray-300 text-left">${nombre}</td>`;


                let totalFila = 0;
                mesesUnicos.forEach((mes, index) => {
                    const registroMes = registros.find(r => `${r.mes.toString().padStart(2, '0')}-${r.anio}` === mes);
                    const monto = registroMes ? registroMes.totalforecastproveedor : null;

                    if (monto === null || monto === 0) {
                        fila += `<td class="p-2 border border-gray-300 text-right"></td>`;
                    } else {
                        totalFila += monto;
                        totalesPorMes[index] += monto;
                        fila += `<td class="p-2 border border-gray-300 text-right">${formatMoneda(monto)}</td>`;
                    }
                });


                fila += `<td class="p-2 border border-gray-300 text-right font-bold">${formatMoneda(totalFila)}</td>`;
                fila += `</tr>`;
                tablaBody.append(fila);
                totalGeneral += totalFila;
            }


            let filaTotales = `
                        <tr class="bg-green-100">
                        <td class="p-2 border border-gray-300 text-left font-bold" colspan="3">Totales</td>`;
            totalesPorMes.forEach(totalMes => {
                filaTotales += `<td class="p-2 border border-gray-300 text-right font-bold">${formatMoneda(totalMes)}</td>`;
            });
            filaTotales += `<td class="p-2 border border-gray-300 text-right font-bold">${formatMoneda(totalGeneral)}</td>`;
            filaTotales += `</tr>`;


            tablaBody.append(filaTotales);
        }


        function agruparPor(array, keys) {
            return array.reduce((result, item) => {
                const groupKey = keys.map(key => item[key]).join('|');
                if (!result[groupKey]) {
                    result[groupKey] = [];
                }
                result[groupKey].push(item);
                return result;
            }, {});
        }


        function formatMoneda(valor) {
            return valor.toLocaleString('de-DE', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }
    });

</script>