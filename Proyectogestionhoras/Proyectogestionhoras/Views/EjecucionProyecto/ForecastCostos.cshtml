@{
    ViewData["Title"] = "Forecast Costos";
}

<style>
    .form-container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 60px;
    }

    .form-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        text-align: center;
        margin-bottom: 10px;
    }

    .form-subtitle {
        font-size: 1.0rem;
        color: #666;
        text-align: center;
        margin-bottom: 20px;
    }



    .highlight {
        background-color: #f8d7da;
        font-weight: bold;
    }

</style>
@{
    int? idproyecto = Context.Session.GetInt32("numproyecto");
}
<div class="form-container">

    <div class="form-group">

        @foreach (var proyecto in ViewBag.Proyecto)
        {

            <p class="form-subtitle" style="color:black;">Información del Proyecto</p>

            <input type="hidden" id="unidadNegocio" value="@proyecto.IDUNEGOCIO" />
            <input type="hidden" id="centroCosto" value="@proyecto.IDCOSTO" />
            <input type="hidden" id="codigo" value="@proyecto.Codigo" />
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-green-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">Número del Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Cliente</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">Departamento</th>
                            <th class="p-2 border border-gray-300 text-left">C.Costo</th>
                            <th class="p-2 border border-gray-300 text-left">Código</th>
                            <th class="p-2 border border-gray-300 text-left">Tipología Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Empresa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.numproyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreProyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreCliente</td>
                            <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MONTO)</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NOMBREDEPARTAMENTO</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_CCosto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Codigo</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Tipologia</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Empresa</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        }
    </div>
    <form asp-action="RegistrarCostos" asp-controller="EjecucionProyecto" method="post">
        <input type="hidden" name="idproyecto" value="@idproyecto"/>
    
    <div class="form-group">

        <p class="form-subtitle" style="color:black;">Status Gastos HH Socios</p>
        <div class="overflow-x-auto">
            <table class="min-w-full text-xs border-collapse">
                <thead>
                    <tr class="bg-blue-100 text-black">
                        
                        <th class="p-2 border border-gray-300 text-left">Fecha</th>
                        <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                        <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                        <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                        <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                        <th class="p-2 border border-gray-300 text-left">Total</th>
                       
                        
                    </tr>
                </thead>
                <tbody>
                    @if (ViewBag.GastosHH != null)
                    {
                            @foreach(var gasto in ViewBag.GastosHH)
                            {
                                @if (gasto.tiporecurso == "Socio")
                                {
                                    <tr>
                                       
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        <td class="p-2 border border-gray-300 text-left"></td>
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2 border border-gray-300 text-left">@gasto.cuenta</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.totalhh)</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.costorecurso)</td>



                                    </tr>
                                }
                                
                            }
                    }
                       
                    
                </tbody>
            </table>
            
        </div>

    </div>

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Staff</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">
                            
                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {
                            @foreach (var gasto in ViewBag.GastosHH)
                            {
                                @if (gasto.tiporecurso == "Staff")
                                {
                                    <tr>
                                        
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        <td class="p-2 border border-gray-300 text-left"></td>
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2 border border-gray-300 text-left">@gasto.cuenta</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.totalhh)</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.costorecurso)</td>



                                    </tr>
                                }

                            }
                        }


                    </tbody>
                </table>

            </div>

        </div>


      

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Consultores Externos</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {
                            @foreach (var gasto in ViewBag.GastosHH)
                            {
                                @if (gasto.tiporecurso == "Consultor Externo")
                                {
                                    <tr>

                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        <td class="p-2 border border-gray-300 text-left"></td>
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2 border border-gray-300 text-left">@gasto.cuenta</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.totalhh)</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.costoconsultoresexternos)</td>



                                    </tr>
                                }

                            }
                        }


                    </tbody>
                </table>

            </div>

        </div>
    @*SERVICIOS*@


    <div class="form-group">

        <p class="form-subtitle" style="color:black;">Status Servicios </p>
        <div class="overflow-x-auto">
            <table id="tablaServicios" class="min-w-full text-xs border-collapse">
                <thead>
                    <tr class="bg-red-100 text-black">
                        <th class="p-2 border border-gray-300 text-left">TipoServicios</th>
                        <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                        <th class="p-2 border border-gray-300 text-left">Monto</th>
                        <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                        <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                        <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                        
                        

                    </tr>
                </thead>
                <tbody>
                        @if (ViewBag.ServiciosEjecucion != null)
                        {
                            @foreach (var se in ViewBag.ServiciosEjecucion)
                            {
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idservicio" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="" disabled selected>Seleccione un Servicio</option>
                                            @if (ViewBag.Servicios != null)
                                            {
                                                @foreach (var servicio in ViewBag.Servicios)
                                                {
                                                    if (servicio.Id == se.Idservicio)
                                                    {
                                                        <option value="@servicio.Id" selected>@servicio.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@servicio.Id">@servicio.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>

                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idproveedor" class="px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="" disabled selected>Seleccione un Servicio</option>
                                            @if (ViewBag.Proveedores != null)
                                            {
                                                @foreach (var proveedor in ViewBag.Proveedores)
                                                {
                                                    if (proveedor.Id == se.Idproveedor)
                                                    {
                                                        <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>

                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}", @se.Monto)" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" value="@se.Fecha.ToString("yyyy-MM-dd")" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                </tr>
                                <input type="hidden" name="IdServicioReal" value="@se.Id"/>
                            }
                        }
                    <tr>
                        <td class="p-2 border border-gray-300 text-left">
                            <select  name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                
                            </select>
                        </td>
                        <td class="p-2 border border-gray-300 text-left">
                            <select  name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                
                            </select>
                        </td>
                            <td class="p-2 border border-gray-300 text-right"><input  type="text" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input  type="date" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                        <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly/></td>
                        <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly/></td>

                            <input type="hidden" name="IdServicioReal" value="" />


                    </tr>
                    
                </tbody>
            </table>
            <button id="btnAgregarServicio" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar Servicio</button>
        </div>

    </div>

    <div class="form-group">

        <p class="form-subtitle" style="color:black;">Status Gastos </p>
        <div class="overflow-x-auto">
                <table id="tablagastos" class="min-w-full text-xs border-collapse">
                <thead>
                    <tr class="bg-yellow-100 text-black">
                        <th class="p-2 border border-gray-300 text-left">TipoGasto</th>
                        <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                        <th class="p-2 border border-gray-300 text-left">Monto</th>
                        <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                        <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                        <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>


                    </tr>
                </thead>
                <tbody>
                        @if (ViewBag.GastosEjecucion != null)
                        {
                            @foreach (var ge in ViewBag.GastosEjecucion)
                            {
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        @if (ViewBag.Gastos != null)
                                        {
                                            @foreach (var gasto in ViewBag.Gastos)
                                            {
                                                if (gasto.Id == ge.IdGasto)
                                                {
                                                    <option value="@gasto.Id" selected>@gasto.Nombre</option>
                                                }
                                                else
                                                {
                                                    <option value="@gasto.Id">@gasto.Nombre</option>
                                                }
                                            }
                                        }

                                    </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            @if (ViewBag.ProGastos != null)
                                            {
                                                @foreach (var proveedor in ViewBag.ProGastos)
                                                {
                                                    if (proveedor.Id == ge.IdProveedor)
                                                    {
                                                        <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" value="@String.Format("{0:N0}", @ge.Monto)" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" value="@ge.Fecha.ToString("yyyy-MM-dd")" /></td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                                    <td style="display:none">
                                        <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                                    </td>
                                </tr>
                                <input type="hidden" name="IdGastoReal" value="@ge.IdGastosReal" />
                            
                            
                            }




                        }
                    <tr>
                        <td class="p-2 border border-gray-300 text-left">
                            <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                
                            </select>
                        </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>

                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                            <td style="display:none">
                                <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                            </td>
                            <td style="display:none;">
                                <input type="hidden" name="IdGastoReal" value="" />
                            </td>
                            



                    </tr>
                    
                </tbody>
            </table>
                <td>
                    <button id="agregarFilaGastos" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar Gasto</button>
                </td>
        </div>

    </div>
        <div class="text-center mt-2">
            <button type="submit" class="bg-green-500 text-white p-3 text-xl w-52 h-12  rounded">Guardar Costos</button>
        </div>
    </form>
</div>


<script>
    /*CARGA INICIAL PAGINA */
    document.addEventListener("DOMContentLoaded", function () {
    
    
    
          const filas = document.querySelectorAll('#tablaServicios tbody tr');

            filas.forEach(fila => {
             obtenerValoresServicioParaFila(fila);
             });
    
    
    });

    /*SERVICIOS */

        function obtenerValoresServicioParaFila(fila) {
            const idUnidadNegocio = $("#unidadNegocio").val();
            const idCentroCosto = $("#centroCosto").val();

            if (idUnidadNegocio && idCentroCosto) {
                $.ajax({
                url: '/Proyecto/GetValoresServicios',
                type: 'GET',
                data: {
                    idcosto: idCentroCosto,
                    idunegocio: idUnidadNegocio
                },
                success: function (response) {
                    if (response && response.length > 0) {
                        
                        $(fila).find('.idcuentaservicio').val(response[0].idcuenta);
                        $(fila).find('.cuentaservicio').val(response[0].cuenta);
                    } else {
                       
                        $(fila).find('.idcuentaservicio').val('');
                        $(fila).find('.cuentaservicio').val('');
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Error al obtener el servicio:', error);
                    $(fila).find('.idcuentaservicio').val('');
                    $(fila).find('.cuentaservicio').val('');
                }
                });
            }
        }



      function cargarServicios(selectElement) {
        $.ajax({
            url: '/Proyecto/ObtenerServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Servicio</option>');

                $.each(data, function (index, servicio) {
                    $(selectElement).append('<option value="' + servicio.id + '">' + servicio.nombre + '</option>');
                });
            },
            error: function () {
                alert('Ocurrió un error al cargar los servicios.');
            }
        });
      }


    $(document).ready(function () {
        $('.serviciosSelect').each(function () {
            cargarServicios(this);
        });
        $('.proveedorSelect').each(function () {
            cargarProveedoresServicios(this);
        });
    });

    function cargarProveedoresServicios(selectElement) {
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function () {

        function formatCurrency(event) {
            let value = event.target.value;


            value = value.replace(/[^\d]/g, '');


            if (value !== '') {

                let formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                event.target.value = formattedValue;
            }
        }

        function removePoints(event) {
            let value = event.target.value;


            value = value.replace(/\./g, '');
            event.target.value = value;
        }


        function cleanInputsOnSubmit(event) {

            const inputs = event.target.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"]');

            inputs.forEach(input => {

                let value = input.value;
                value = value.replace(/\./g, '');
                input.value = value;
            });
        }


        const montoInputs = document.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"]');


        montoInputs.forEach(input => {
            input.addEventListener('input', formatCurrency);
        });


        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', cleanInputsOnSubmit);
        }
         document.getElementById("btnAgregarServicio").addEventListener("click", function () {
        
                setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montoservicio"]');

                        nuevosMontos.forEach(input => {
                            if (!input.hasAttribute('data-format-listener')) { 
                            input.addEventListener('input', formatCurrency);
                            input.setAttribute('data-format-listener', 'true'); 
                        }
                    });
                }, 100);
          });
        document.getElementById("agregarFilaGastos").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montogasto"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });
    });


     document.addEventListener('DOMContentLoaded', function () {
        


        const agregarServicioButtons = document.querySelectorAll('button[id^="btnAgregarServicio"]');

        agregarServicioButtons.forEach(button => {
            button.addEventListener('click', function (e) {
                e.preventDefault();

                
                const tablaId = button.id.replace('btnAgregarServicio', 'tablaServicios');
                const tableBody = document.querySelector(`#${tablaId} tbody`);

                if (!tableBody) {
                    console.error(`No se encontró la tabla con ID ${tablaId}`);
                    return;
                }

                
                const lastRow = tableBody.querySelector('tr:last-child');

                if (!lastRow) {
                    console.error('No hay filas en la tabla para clonar.');
                    return;
                }

                const newRow = lastRow.cloneNode(true);

             
                newRow.querySelectorAll('input').forEach(input => {
                    input.value = '';
                });

                
                newRow.querySelectorAll('select').forEach(select => {
                    select.value = '';

                });

                
                tableBody.appendChild(newRow);

                newRow.querySelectorAll('.serviciosSelect').forEach(select => {
                    cargarServicios(select);
                });
                newRow.querySelectorAll('.proveedorSelect').forEach(select => {
                    cargarProveedoresServicios(select);
                });

                
                obtenerValoresServicioParaFila(newRow);
            });
        });

    });



    /*GASTOS*/
    $(document).ready(function () {
       
        $('.gastosSelect').each(function () {
            var $select = $(this);
            var $row = $select.closest('tr');

         
            var selectedOption = $select.find('option:selected').val();
            if (selectedOption) {
               
                const idUnidadNegocio = $("#unidadNegocio").val();
                const idCentroCosto = $("#centroCosto").val();
                var nombreGasto = $select.find('option:selected').text();

                $.ajax({
                    url: '/Proyecto/GetValoresGastosEdicion',
                    type: 'GET',
                    data: {
                        idcosto: idCentroCosto,
                        unegocio: idUnidadNegocio,
                        nombresegmento: nombreGasto
                    },
                    success: function (data) {
                        if (data && data.length > 0) {
                            $row.find('.segmentogastos').val(data[0].nombre);
                            $row.find('.idcuentagastos').val(data[0].idcuenta);
                            $row.find('.cuentagastos').val(data[0].cuenta);
                            $row.find('.idsegmentogasto').val(data[0].idsegmento);
                        } else {
                            console.log("No se encontraron valores.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", error);
                    }
                });
            }
        });
    });

    $(document).on('change', '.gastosSelect', function () {
        var $row = $(this).closest('tr');
        const idUnidadNegocio = $("#unidadNegocio").val();
        const idCentroCosto = $("#centroCosto").val();
        var nombreGasto = $(this).find('option:selected').text();
        console.log(idUnidadNegocio);
        console.log(idCentroCosto);
        console.log(nombreGasto);
        $.ajax({
            url: '/Proyecto/GetValoresGastosEdicion',
            type: 'GET',
            data: {
                idcosto: idCentroCosto,
                unegocio: idUnidadNegocio,
                nombresegmento: nombreGasto
            },
            success: function (data) {
                if (data && data.length > 0) {

                    $row.find('.segmentogastos').val(data[0].nombre);
                    $row.find('.idcuentagastos').val(data[0].idcuenta);
                    $row.find('.cuentagastos').val(data[0].cuenta);
                    $row.find('.idsegmentogasto').val(data[0].idsegmento);
                } else {
                    console.log("No se encontraron valores.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
    });

    function cargarGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/Proyecto/ObtenerGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un gasto</option>');


                $.each(data, function (index, gasto) {
                    $(selectElement).append('<option value="' + gasto.id + '">' + gasto.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los gastos.');
            }
        });
    }

    function cargarProveedoresGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }


    $(document).ready(function () {
        
        $('.gastosSelect').each(function () {
            cargarGastos(this);
        });
        $('.proveedorGastosSelect').each(function () {
            cargarProveedoresGastos(this);
        });

        
        $('#agregarFilaGastos').on('click', function (e) {
            e.preventDefault(); 

            
            var nuevaFila = `
                <tr>
                    <td class="p-2 border border-gray-300 text-left">
                        <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Seleccione un gasto</option>
                        </select>
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                         <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Seleccione un proveedor</option>
                        </select>
                    </td>
                    <td class="p-2 border border-gray-300 text-right">
                        <input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                        <input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                    </td>
                    <td class="p-2 border border-gray-300 text-right">
                        <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly />
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                        <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly />
                    </td>
                    <td style="display:none">
                        <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                    </td>
                    <td style="display:none;">
                        <input type="hidden" name="IdGastoReal" value="" />
                    </td>
                </tr>
            `;

            
            $('#tablagastos tbody').append(nuevaFila);

            
            $('#tablagastos tbody tr:last .gastosSelect').each(function () {
                cargarGastos(this);
            });
            $('#tablagastos tbody tr:last .proveedorGastosSelect').each(function () {
                cargarProveedoresGastos(this);
            });
        });
    });

   

</script>