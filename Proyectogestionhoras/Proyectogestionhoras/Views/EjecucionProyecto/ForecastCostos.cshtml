@{
    ViewData["Title"] = "Forecast Costos";
}

<style>
    .form-container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-top: 60px;
    }

    .form-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    text-align: center;
    margin-bottom: 10px;
    }

    .form-subtitle {
    font-size: 1.0rem;
    color: #666;
    text-align: center;
    margin-bottom: 20px;
    }



    .highlight {
    background-color: #f8d7da;
    font-weight: bold;
    }

    .panel-container {
    display: flex;
    justify-content: space-between;
    gap: 0px;
    width: 100%;
    margin-top: 0;
    padding-top: 0;
    }

    .panel-item {
    flex-grow: 1;
    border: 2px solid #444;
    border-radius: 0;
    padding: 10px 20px;
    background-color: #f2f3f4;
    color: black;
    text-align: center;
    transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
    }



    .panel-item:hover {
    background-color: #fcaa67;
    color: #fff;
    }
</style>
@{
    int? idproyecto = Context.Session.GetInt32("numproyecto");
    decimal totalsocios = 0;
    decimal totalstaff = 0;
    decimal totalconsutlores = 0;
    decimal totalsociosproyectados = 0;
    decimal totalstaffproyectados = 0;
    decimal totalconsutlroaproyectados = 0;
    decimal totalconsutlrobproyectados = 0;
    decimal totalconsutlrocproyectados = 0;
    decimal totalconsultoresproyectados = 0;
    decimal totalserviciosproyectados = 0;
    decimal totalgastosproyectados = 0;
    decimal totalcostosproyectados = 0;
    int idcuentasocio = 0;
    string? cuentasocio = "";
    int idcuentastaff = 0;
    string? cuentastaff = "";
    int idcuentaconsultores = 0;
    string? cuentaconsultores = "";
}

<div class="form-container">
    <div class="panel-container flex justify-center mb-5">
        <a href="@Url.Action("ForecastIngreso","EjecucionProyecto",new{id=idproyecto})" class="panel-item bg-blue-500 text-white px-4 py-2 rounded-l hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
            Forecast Ingresos del Proyecto
        </a>
        <a href="@Url.Action("FlujoCajaProyecto","EjecucionProyecto",new{id=idproyecto})" class="panel-item bg-green-500 text-white px-4 py-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">
            Flujo de Caja del Proyecto
        </a>
        <a href="@Url.Action("SeleccionarProyecto","EjecucionProyecto",new{statusproyecto=2})" class="panel-item bg-gray-500 text-white px-4 py-2 rounded-r hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">
            Seleccionar otro Proyecto
        </a>
    </div>
    <div class="form-group">

        @foreach (var proyecto in ViewBag.Proyecto)
        {

            <p class="form-subtitle" style="color:black;">Información del Proyecto</p>

            <input type="hidden" id="unidadNegocio" value="@proyecto.IDUNEGOCIO" />
            <input type="hidden" id="centroCosto" value="@proyecto.IDCOSTO" />
            <input type="hidden" id="codigo" value="@proyecto.Codigo" />
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-green-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">Número del Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Cliente</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">Departamento</th>
                            <th class="p-2 border border-gray-300 text-left">C.Costo</th>
                            <th class="p-2 border border-gray-300 text-left">Código</th>
                            <th class="p-2 border border-gray-300 text-left">Tipología Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Empresa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.numproyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreProyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreCliente</td>
                            <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MontoPresupuesto)</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NOMBREDEPARTAMENTO</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_CCosto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Codigo</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Tipologia</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Empresa</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            totalsociosproyectados = proyecto.CostoSocioPresupuesto;
            totalstaffproyectados = proyecto.CostoStaffPresupuesto;
            totalconsutlroaproyectados = proyecto.CostoConsultorAPresupuesto;
            totalconsutlrobproyectados = proyecto.CostoConsultorBPresupuesto;
            totalconsutlrocproyectados = proyecto.CostoConsultorCPresupuesto;
            totalconsultoresproyectados = totalconsutlroaproyectados + totalconsutlrobproyectados + totalconsutlrocproyectados;
        }
    </div>
    <form asp-action="RegistrarCostos" asp-controller="EjecucionProyecto" method="post">
        <input type="hidden" name="idproyecto" value="@idproyecto"/>

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Socios</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-1 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">SubTotal</th>
                            <th class="p-2 border border-gray-300 text-left">Reajuste</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>
                            <th class="p-2 border border-gray-300 text-left">Observación</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {

                            @for (int i = 0; i < ViewBag.GastosHH.Count; i++)
                            {

                                var gasto = ViewBag.GastosHH[i];
                                @if (gasto.tiporecurso == "Socio")
                                {


                                    <tr>
                                        <input type="hidden" name="gastosHH[@i].Tiporecurso" value="@gasto.tiporecurso" />
                                        <input type="hidden" name="gastosHH[@i].Mes" value="@gasto.mes" />
                                        <input type="hidden" name="gastosHH[@i].Anio" value="@gasto.anio" />
                                        <input type="hidden" name="gastosHH[@i].Subtotal" value="@gasto.costorecurso" />
                                        <input type="hidden" name="gastosHH[@i].HHtotales" value="@gasto.totalhh" />
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos!=null)
                                        {
                                            <input type="hidden" name="gastosHH[@i].IdGastoHH" value="@ViewBag.GastosRecursos[i].Id" />
                                            <td class="p-1 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" value="@ViewBag.GastosRecursos[i].Fechapago?.ToString("yyyy-MM-dd")" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                                            </td>
                                        }
                                        else
                                        {
                                            <td class="p-1 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                                            </td>
                                        }

                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-1">@gasto.cuenta</td>

                                        <td class="p-1 border border-gray-300 text-right w-20">@String.Format("{0:N2}", gasto.totalhh)</td>
                                        <td class="p-1 border border-gray-300 text-right w-25">@String.Format("{0:N0}", gasto.costorecurso)</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null){
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Reajuste ?? "")" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montosocio" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Monto ?? "")" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montosocio" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos != null && ViewBag.GastosRecursos.Count > i)
                                        {

                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"> @ViewBag.GastosRecursos[i].Observacion</textarea>
                                            </td>

                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                            </td>
                                        }



                                        @{
                                            totalsocios += Convert.ToDecimal(gasto.costorecurso ?? 0);
                                            cuentasocio = gasto.cuenta;
                                            idcuentasocio = gasto.idcuenta;
                                        }
                                    </tr>
                                }
                            }

                        }


                    </tbody>
                </table>

            </div>

        </div>

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Staff</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">SubTotal</th>
                            <th class="p-2 border border-gray-300 text-left">Reajuste</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>
                            <th class="p-2 border border-gray-300 text-left">Observación</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {
                            @for (int i = 0; i < ViewBag.GastosHH.Count; i++)
                            {

                                var gasto = ViewBag.GastosHH[i];
                                @if (gasto.tiporecurso == "Staff")
                                {


                                    <tr>
                                        <input type="hidden" name="gastosHH[@i].Tiporecurso" value="@gasto.tiporecurso" />
                                        <input type="hidden" name="gastosHH[@i].Mes" value="@gasto.mes" />
                                        <input type="hidden" name="gastosHH[@i].Anio" value="@gasto.anio" />
                                        <input type="hidden" name="gastosHH[@i].Subtotal" value="@gasto.costorecurso" />
                                        <input type="hidden" name="gastosHH[@i].HHtotales" value="@gasto.totalhh" />
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <input type="hidden" name="gastosHH[@i].IdGastoHH" value="@ViewBag.GastosRecursos[i].Id" />
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" value="@ViewBag.GastosRecursos[i].Fechapago?.ToString("yyyy-MM-dd")" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                        }
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2">@gasto.cuenta</td>
                                        <td class="p-1 border border-gray-300 text-right w-20">@String.Format("{0:N2}", gasto.totalhh)</td>
                                        <td class="p-1 border border-gray-300 text-right w-25">@String.Format("{0:N0}", gasto.costorecurso)</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Reajuste ?? "")" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montostaff" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Monto ?? "")" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montostaff" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos != null && ViewBag.GastosRecursos.Count > i)
                                        {

                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"> @ViewBag.GastosRecursos[i].Observacion</textarea>
                                            </td>

                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                            </td>
                                        }
                                        @{
                                            totalstaff += Convert.ToDecimal(gasto.costorecurso ?? 0);
                                            idcuentastaff = gasto.idcuenta;
                                            cuentastaff = gasto.cuenta;
                                        }
                                    </tr>
                                }
                            }


                        }


                    </tbody>
                </table>

            </div>

        </div>




        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos HH Consultores Externos</p>
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-blue-100 text-black">

                            <th class="p-2 border border-gray-300 text-left">Fecha</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                            <th class="p-2 border border-gray-300 text-left">Horas Efectivas</th>
                            <th class="p-2 border border-gray-300 text-left">SubTotal</th>
                            <th class="p-2 border border-gray-300 text-left">Reajuste</th>
                            <th class="p-2 border border-gray-300 text-left">Total</th>
                            <th class="p-2 border border-gray-300 text-left">Observación</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosHH != null)
                        {
                            @for (int i = 0; i < ViewBag.GastosHH.Count; i++)
                            {

                                var gasto = ViewBag.GastosHH[i];
                                @if (gasto.tiporecurso == "Consultor Externo")
                                {


                                    <tr>
                                        <input type="hidden" name="gastosHH[@i].Tiporecurso" value="@gasto.tiporecurso" />
                                        <input type="hidden" name="gastosHH[@i].Mes" value="@gasto.mes" />
                                        <input type="hidden" name="gastosHH[@i].Anio" value="@gasto.anio" />
                                        <input type="hidden" name="gastosHH[@i].Subtotal" value="@gasto.costoconsultoresexternos" />
                                        <input type="hidden" name="gastosHH[@i].HHtotales" value="@gasto.totalhh" />
                                        <td class="p-2 border border-gray-300 text-left">@gasto.mes/@gasto.anio</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <input type="hidden" name="gastosHH[@i].IdGastoHH" value="@ViewBag.GastosRecursos[i].Id" />
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" value="@ViewBag.GastosRecursos[i].Fechapago?.ToString("yyyy-MM-dd")" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right">
                                                <input type="date" name="gastosHH[@i].Fechapago" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                                            </td>
                                        }
                                        <td class="p-2 border border-gray-300 text-right">@gasto.idcuenta</td>
                                        <td class="p-2">@gasto.cuenta</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N2}", gasto.totalhh)</td>
                                        <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", gasto.costoconsultoresexternos)</td>
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Reajuste ?? "")" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" name="gastosHH[@i].Reajuste" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos.Count > i && ViewBag.GastosRecursos != null)
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montoconsultores" value="@String.Format("{0:N0}",ViewBag.GastosRecursos[i]?.Monto ?? "")" readonly name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-right"><input type="text" readonly id="montoconsultores" name="gastosHH[@i].Monto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                        }
                                        @if (ViewBag.GastosRecursos != null && ViewBag.GastosRecursos.Count > i)
                                        {

                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"> @ViewBag.GastosRecursos[i].Observacion</textarea>
                                            </td>

                                        }
                                        else
                                        {
                                            <td class="p-2 border border-gray-300 text-left">
                                                <textarea rows="2" name="gastosHH[@i].Observacion" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                            </td>
                                        }

                                        @{
                                            totalconsutlores += Convert.ToDecimal(gasto.costoconsultoresexternos ?? 0);
                                            idcuentaconsultores = gasto.idcuenta;
                                            cuentaconsultores = gasto.cuenta;
                                        }
                                    </tr>
                                }
                            }

                        }


                    </tbody>
                </table>

            </div>

        </div>
        @*SERVICIOS*@


        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Servicios </p>
            <div class="overflow-x-auto">
                <table id="tablaServicios" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-red-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoServicios</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Observación</th>

                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>



                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.ServiciosEjecucion != null)
                        {
                            @foreach (var se in ViewBag.ServiciosEjecucion)
                            {
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="" disabled selected>Seleccione un Servicio</option>
                                            @if (ViewBag.Servicios != null)
                                            {
                                                @foreach (var servicio in ViewBag.Servicios)
                                                {
                                                    if (servicio.Id == se.Idservicio)
                                                    {
                                                        <option value="@servicio.Id" selected>@servicio.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@servicio.Id">@servicio.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>

                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="" disabled selected>Seleccione un Servicio</option>
                                            @if (ViewBag.Proveedores != null)
                                            {
                                                @foreach (var proveedor in ViewBag.Proveedores)
                                                {
                                                    if (proveedor.Id == se.Idproveedor)
                                                    {
                                                        <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>

                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" value="@String.Format("{0:N0}", @se.Monto)" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" value="@se.Fecha.ToString("yyyy-MM-dd")" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@se.Observacion</textarea>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly /></td>
                                </tr>
                                <input type="hidden" name="IdServicioReal" value="@se.Id"/>
                            }
                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select  name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select  name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-right"><input  type="text" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input  type="date" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly/></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly/></td>

                            <input type="hidden" name="IdServicioReal" value="" />


                        </tr>

                    </tbody>
                </table>
                <button id="btnAgregarServicio" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Servicio</button>
            </div>

        </div>

        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Status Gastos </p>
            <div class="overflow-x-auto">
                <table id="tablagastos" class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-yellow-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">TipoGasto</th>
                            <th class="p-2 border border-gray-300 text-left">Proveedor</th>
                            <th class="p-2 border border-gray-300 text-left">Monto</th>
                            <th class="p-2 border border-gray-300 text-left">FechaPago</th>
                            <th class="p-2 border border-gray-300 text-left">Observación</th>
                            <th class="p-2 border border-gray-300 text-left">IDCUENTA</th>
                            <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>


                        </tr>
                    </thead>
                    <tbody>
                        @if (ViewBag.GastosEjecucion != null)
                        {
                            @foreach (var ge in ViewBag.GastosEjecucion)
                            {
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            @if (ViewBag.Gastos != null)
                                            {
                                                @foreach (var gasto in ViewBag.Gastos)
                                                {
                                                    if (gasto.Id == ge.IdGasto)
                                                    {
                                                        <option value="@gasto.Id" selected>@gasto.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@gasto.Id">@gasto.Nombre</option>
                                                    }
                                                }
                                            }

                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            @if (ViewBag.ProGastos != null)
                                            {
                                                @foreach (var proveedor in ViewBag.ProGastos)
                                                {
                                                    if (proveedor.Id == ge.IdProveedor)
                                                    {
                                                        <option value="@proveedor.Id" selected>@proveedor.Nombre</option>
                                                    }
                                                    else
                                                    {
                                                        <option value="@proveedor.Id">@proveedor.Nombre</option>
                                                    }
                                                }
                                            }
                                        </select>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" value="@String.Format("{0:N0}", @ge.Monto)" /></td>
                                    <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" value="@ge.Fecha.ToString("yyyy-MM-dd")" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                        <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48">@ge.Observacion</textarea>
                                    </td>
                                    <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                                    <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                                    <td style="display:none">
                                        <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                                    </td>
                                </tr>
                                <input type="hidden" name="IdGastoReal" value="@ge.IdGastosReal" />


                            }




                        }
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </select>
                            </td>

                            <td class="p-2 border border-gray-300 text-right"><input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                            <td class="p-2 border border-gray-300 text-left"><input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                            <td class="p-2 border border-gray-300 text-left">
                                <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                            </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly /></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly /></td>
                            <td style="display:none">
                                <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                            </td>
                            <td style="display:none;">
                                <input type="hidden" name="IdGastoReal" value="" />
                            </td>




                        </tr>

                    </tbody>
                </table>
                <td>
                    <button id="agregarFilaGastos" class="px-4 py-2 text-sm text-white bg-blue-500 border border-gray-300 rounded transition duration-300 ease-in-out hover:bg-blue-400 hover:opacity-80">Agregar otro Gasto</button>
                </td>
            </div>

        </div>
        <div class="form-group">

            <p class="form-subtitle" style="color:black;">Total Costos del proyecto </p>
            <div class="flex justify-center items-center py-5">
                <div class="overflow-x-auto w-1/2">
                    <table id="tablaresumen" class="min-w-full text-xs border-collapse border border-gray-300">
                        <thead>
                            <tr class="bg-red-400 text-black">
                                <th class="p-2 border border-gray-300 text-left">Tipo</th>
                                <th class="p-2 border border-gray-300 text-left">IdCuenta</th>
                                <th class="p-2 border border-gray-300 text-left">Cuenta Contable</th>
                                <th class="p-2 border border-gray-300 text-center">Total Proyectado</th>
                                <th class="p-2 border border-gray-300 text-center">Total Real</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="p-2 border border-gray-300 text-left">HH Socios</td>
                                @if (idcuentasocio > 0)
                                {
                                    <td class="p-2 border border-gray-300 text-left">@idcuentasocio</td>
                                }
                                else
                                {
                                    <td class="p-2 border border-gray-300 text-left"></td>
                                }

                                <td class="p-2 border border-gray-300 text-left">@cuentasocio</td>
                                <td class="p-2 border border-gray-300 text-right" >@String.Format("{0:N0}", totalsociosproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right" id="totalSocios">0</td>
                            </tr>
                            <tr>
                                <td class="p-2 border border-gray-300 text-left">HH Staff</td>
                                @if (idcuentastaff > 0)
                                {
                                    <td class="p-2 border border-gray-300 text-left">@idcuentastaff</td>
                                }
                                else
                                {
                                    <td class="p-2 border border-gray-300 text-left"></td>
                                }

                                <td class="p-2 border border-gray-300 text-left">@cuentastaff</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalstaffproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right" id="totalStaff">0</td>
                            </tr>
                            <tr>
                                <td class="p-2 border border-gray-300 text-left">HH Consultores Externos</td>
                                @if (idcuentaconsultores > 0)
                                {
                                    <td class="p-2 border border-gray-300 text-left">@idcuentaconsultores</td>
                                }
                                else
                                {
                                    <td class="p-2 border border-gray-300 text-left"></td>
                                }

                                <td class="p-2 border border-gray-300 text-left">@cuentaconsultores</td>
                                <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", totalconsultoresproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right" id="totalConsultores">0</td>
                            </tr>
                            @foreach (var servicio in ViewBag.ServiciosProyectos)
                            {
                                decimal totaleservicio = 0;
                                if (ViewBag.ServiciosTotales.ContainsKey(servicio.IDSERVICIO))
                                {
                                    totaleservicio = ViewBag.ServiciosTotales[servicio.IDSERVICIO];
                                }
                                <tr data-id="@servicio.IDSERVICIO">
                                    <td class="p-2 border border-gray-300 text-left">@servicio.NOMBRESERVICIO</td>
                                    <td class="p-2 border border-gray-300 text-left">@servicio.IDCUENTA</td>
                                    <td class="p-2 border border-gray-300 text-left">@servicio.CUENTA</td>
                                    <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @servicio.MONTO)</td>
                                    <td class="p-2 border border-gray-300 text-right total-row" >@String.Format("{0:N0}", @totaleservicio)</td>
                                </tr>
                                totalserviciosproyectados += servicio.MONTO;
                            }
                            @foreach (var gasto in ViewBag.GastosProyectos)
                            {
                                decimal totalesgasto = 0;
                                if (ViewBag.GastosTotales.ContainsKey(gasto.IDGASTOS))
                                {
                                    totalesgasto = ViewBag.GastosTotales[gasto.IDGASTOS];
                                }
                                <tr>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.NOMBREGASTO</td>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.IDCUENTA</td>
                                    <td class="p-2 border border-gray-300 text-left">@gasto.CUENTA</td>
                                    <td class="p-2 border border-gray-300 text-right">@String.Format("{0:N0}", @gasto.MONTO)</td>
                                    <td class="p-2 border border-gray-300 text-right" id="totalGastos_@gasto.IDGASTOS">@String.Format("{0:N0}", @totalesgasto)</td>
                                </tr>
                                totalgastosproyectados += gasto.MONTO;
                            }
                            
                            <tr>
                                @{
                                    totalcostosproyectados = totalsociosproyectados + totalstaffproyectados + totalconsultoresproyectados + totalserviciosproyectados + totalgastosproyectados;
                                }
                                <td colspan="3" class="p-2 border border-gray-300 text-left font-bold">Totales</td>
                                
                                <td class="p-2 border border-gray-300 text-right font-bold">@String.Format("{0:N0}", totalcostosproyectados)</td>
                                <td class="p-2 border border-gray-300 text-right font-bold" id="totalCostos">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


        </div>
        <div class="text-center mt-2">
            <button type="submit" class="bg-green-500 text-white p-3 text-xl w-52 h-12  rounded">Guardar Costos</button>
        </div>
    </form>
</div>


<script>
    

    /*SERVICIOS */

    $(document).ready(function () {

        $('.serviciosSelect').each(function () {
            var $select = $(this);
            var $row = $select.closest('tr');


            var selectedOption = $select.find('option:selected').val();
            if (selectedOption) {

                const idUnidadNegocio = $("#unidadNegocio").val();
                const idCentroCosto = $("#centroCosto").val();
                var nombreservicio = $(this).find('option:selected').val();
                

                $.ajax({
                    url: '/Proyecto/GetValoresServiciosEdicion',
                    type: 'GET',
                    data: {
                        idcosto: idCentroCosto,
                        unegocio: idUnidadNegocio,
                        idservicio: nombreservicio
                    },
                    success: function (data) {
                        if (data && data.length > 0) {
                            $row.find('.idcuentaservicio').val(data[0].idcuenta);
                            $row.find('.cuentaservicio').val(data[0].cuenta);
                        } else {
                            console.log("No se encontraron valores.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", error);
                    }
                });
            }
        });
    });


    $(document).on('change', '.serviciosSelect', function () {
        var $row = $(this).closest('tr');
        const idUnidadNegocio = $("#unidadNegocio").val();
        const idCentroCosto = $("#centroCosto").val();
        var nombreservicio = $(this).find('option:selected').val();
        console.log(idUnidadNegocio);
        console.log(idCentroCosto);
        console.log(nombreservicio);
        $.ajax({
            url: '/Proyecto/GetValoresServiciosEdicion',
            type: 'GET',
            data: {
                idcosto: idCentroCosto,
                unegocio: idUnidadNegocio,
                idservicio: nombreservicio
            },
            success: function (data) {
                if (data && data.length > 0) {

                    
                    $row.find('.idcuentaservicio').val(data[0].idcuenta);
                    $row.find('.cuentaservicio').val(data[0].cuenta);
                    
                } else {
                    console.log("No se encontraron valores.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
    });

   



      function cargarServicios(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/Proyecto/ObtenerServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Servicio</option>');

                $.each(data, function (index, servicio) {
                    $(selectElement).append('<option value="' + servicio.id + '">' + servicio.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los servicios.');
            }
        });
      }


    $(document).ready(function () {
        $('.serviciosSelect').each(function () {
            cargarServicios(this);
        });
        $('.proveedorSelect').each(function () {
            cargarProveedoresServicios(this);
        });
    });

    function cargarProveedoresServicios(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresServicios',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }

    /*FORMATEAR MONTOS SERVICIOS Y GASTOS*/ 
    document.addEventListener('DOMContentLoaded', function () {

        function formatCurrency(event) {
            let value = event.target.value;

            
            value = value.replace(/[^\d-]/g, '');

           
            if (value.includes('-') && value.indexOf('-') > 0) {
                value = '-' + value.replace(/-/g, '');
            }

            if (value !== '' && value !== '-') {
                const isNegative = value.startsWith('-'); 
                value = value.replace(/-/g, '');

             
                let formattedValue = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                
                if (isNegative) {
                    formattedValue = '-' + formattedValue;
                }

                event.target.value = formattedValue; 
            } else {
                event.target.value = value; 
            }

            updateMonto(event.target); 
            updateTotal(); 
        }

        

        function removePoints(event) {
            let value = event.target.value;


            value = value.replace(/\./g, '');
            event.target.value = value;
        }

        function updateMonto(reajusteInput) {
            const row = reajusteInput.closest('tr'); 
            const reajusteValue = parseCurrency(reajusteInput.value); 
            const subtotalValue = parseCurrency(row.querySelector('input[name*="Subtotal"]').value); 
            const montoInput = row.querySelector('input[name*="Monto"]'); 

            const total = reajusteValue + subtotalValue; 
            montoInput.value = total.toLocaleString('es-CL'); 
        }

        const reajusteInputs = document.querySelectorAll('input[name*="Reajuste"]');

        reajusteInputs.forEach(input => {
            input.addEventListener('input', formatCurrency); 
        });

        function parseCurrency(value) {
            return parseInt(value.replace(/\./g, ''), 10) || 0;
        }

        
        function updateTotal() {
            let totalservicio = 0;
            let totalgasto = 0;
            let totalsocio= 0;
            let totalstaff= 0;
            let totalconsultores= 0;
            let totalCostos = 0;
            const montogastoInput = document.querySelectorAll('input[name*="montogasto"]');
            const montoInputs = document.querySelectorAll('input[name*="montoservicio"]');
            const montoSocioInputs = document.querySelectorAll('input[id*="montosocio"]');
            const montoStaffInputs = document.querySelectorAll('input[id*="montostaff"]');
            const montoConsultoresInputs = document.querySelectorAll('input[id*="montoconsultores"]');
            
            
            montoInputs.forEach(input => {
                totalservicio += parseCurrency(input.value);
            });
            montogastoInput.forEach(input => {
                totalgasto += parseCurrency(input.value);
            });
            montoSocioInputs.forEach(input => {
                totalsocio += parseCurrency(input.value);
            });
            montoStaffInputs.forEach(input => {
                totalstaff += parseCurrency(input.value);
            });
            montoConsultoresInputs.forEach(input => {
                totalconsultores += parseCurrency(input.value);
            });
            document.getElementById('totalSocios').textContent = totalsocio.toLocaleString('es-CL');
            document.getElementById('totalStaff').textContent = totalstaff.toLocaleString('es-CL');
            document.getElementById('totalConsultores').textContent = totalconsultores.toLocaleString('es-CL');
            
            const totalSocios = parseCurrency(document.getElementById('totalSocios').textContent);
            const totalStaff = parseCurrency(document.getElementById('totalStaff').textContent);
            const totalConsultores = parseCurrency(document.getElementById('totalConsultores').textContent);

            
            totalCostos = totalSocios + totalStaff + totalConsultores + totalservicio + totalgasto;

            
            document.getElementById('totalCostos').textContent = totalCostos.toLocaleString('es-CL');
        }


        function cleanInputsOnSubmit(event) {

            const inputs = event.target.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"], input[name*="Reajuste"], input[name*="Monto"]');

            inputs.forEach(input => {

                let value = input.value;
                value = value.replace(/\./g, '');
                input.value = value;
            });
        }

       

        
     


        const montoInputs = document.querySelectorAll('input[name*="montoservicio"], input[name*="montogasto"],input[name*="Reajuste"]');


        montoInputs.forEach(input => {
            input.addEventListener('input', formatCurrency);
        });


        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', cleanInputsOnSubmit);
        }
         document.getElementById("btnAgregarServicio").addEventListener("click", function () {
        
                setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montoservicio"]');

                        nuevosMontos.forEach(input => {
                            if (!input.hasAttribute('data-format-listener')) { 
                            input.addEventListener('input', formatCurrency);
                            input.setAttribute('data-format-listener', 'true'); 
                        }
                    });
                }, 100);
          });
        document.getElementById("agregarFilaGastos").addEventListener("click", function () {

            setTimeout(() => {

                const nuevosMontos = document.querySelectorAll('input[name*="montogasto"]');

                nuevosMontos.forEach(input => {
                    if (!input.hasAttribute('data-format-listener')) {
                        input.addEventListener('input', formatCurrency);
                        input.setAttribute('data-format-listener', 'true');
                    }
                });
            }, 100);
        });
        
        updateTotal();
    });


    $(document).ready(function () {

        $('.serviciosSelect').each(function () {
            cargarServicios(this);
        });
        $('.proveedorSelect').each(function () {
            cargarProveedoresServicios(this);
        });


        $('#btnAgregarServicio').on('click', function (e) {
            e.preventDefault();


            var nuevaFila = `
                       <tr>
                            <td class="p-2 border border-gray-300 text-left">
                                <select  name="Idservicio" class="serviciosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                </select>
                            </td>
                            <td class="p-2 border border-gray-300 text-left">
                                <select  name="Idproveedor" class="proveedorSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">

                                </select>
                            </td>
                                <td class="p-2 border border-gray-300 text-right"><input  type="text" id="montoservicio" name="montoservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" /></td>
                                <td class="p-2 border border-gray-300 text-left"><input  type="date" name="fechaservicio" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" /></td>
                                    <td class="p-2 border border-gray-300 text-left">
                                    <textarea rows="2" name="observacionservicio" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                </td>
                            <td class="p-2 border border-gray-300 text-right "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentaservicio" readonly/></td>
                            <td class="p-2 border border-gray-300 text-left "><input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentaservicio" readonly/></td>

                                <input type="hidden" name="IdServicioReal" value="" />


                        </tr>
                `;


            $('#tablaServicios tbody').append(nuevaFila);


            $('#tablaServicios tbody tr:last .serviciosSelect').each(function () {
                cargarServicios(this);
            });
            $('#tablaServicios tbody tr:last .proveedorSelect').each(function () {
                cargarProveedoresServicios(this);
            });
        });
    });



    /*GASTOS*/
    $(document).ready(function () {
       
        $('.gastosSelect').each(function () {
            var $select = $(this);
            var $row = $select.closest('tr');

         
            var selectedOption = $select.find('option:selected').val();
            if (selectedOption) {
               
                const idUnidadNegocio = $("#unidadNegocio").val();
                const idCentroCosto = $("#centroCosto").val();
                var nombreGasto = $select.find('option:selected').val();

                $.ajax({
                    url: '/Proyecto/GetValoresGastosEdicion',
                    type: 'GET',
                    data: {
                        idcosto: idCentroCosto,
                        unegocio: idUnidadNegocio,
                        idgasto: nombreGasto
                    },
                    success: function (data) {
                        if (data && data.length > 0) {
                            $row.find('.segmentogastos').val(data[0].nombre);
                            $row.find('.idcuentagastos').val(data[0].idcuenta);
                            $row.find('.cuentagastos').val(data[0].cuenta);
                            $row.find('.idsegmentogasto').val(data[0].idsegmento);
                        } else {
                            console.log("No se encontraron valores.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error en la solicitud AJAX:", error);
                    }
                });
            }
        });
    });

    $(document).on('change', '.gastosSelect', function () {
        var $row = $(this).closest('tr');
        const idUnidadNegocio = $("#unidadNegocio").val();
        const idCentroCosto = $("#centroCosto").val();
        var nombreGasto = $(this).find('option:selected').val();
        
        $.ajax({
            url: '/Proyecto/GetValoresGastosEdicion',
            type: 'GET',
            data: {
                idcosto: idCentroCosto,
                unegocio: idUnidadNegocio,
                idgasto: nombreGasto
            },
            success: function (data) {
                if (data && data.length > 0) {

                    $row.find('.segmentogastos').val(data[0].nombre);
                    $row.find('.idcuentagastos').val(data[0].idcuenta);
                    $row.find('.cuentagastos').val(data[0].cuenta);
                    $row.find('.idsegmentogasto').val(data[0].idsegmento);
                } else {
                    console.log("No se encontraron valores.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Error en la solicitud AJAX:", error);
            }
        });
    });

    function cargarGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/Proyecto/ObtenerGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un gasto</option>');


                $.each(data, function (index, gasto) {
                    $(selectElement).append('<option value="' + gasto.id + '">' + gasto.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los gastos.');
            }
        });
    }

    function cargarProveedoresGastos(selectElement) {
        var valorSeleccionado = $(selectElement).val();
        $.ajax({
            url: '/EjecucionProyecto/ObtenerProveedoresGastos',
            type: 'GET',
            success: function (data) {
                $(selectElement).empty();
                $(selectElement).append('<option value="" disabled selected>Seleccione un Proveedor</option>');

                $.each(data, function (index, proveedor) {
                    $(selectElement).append('<option value="' + proveedor.id + '">' + proveedor.nombre + '</option>');
                });
                if (valorSeleccionado) {
                    $(selectElement).val(valorSeleccionado);
                }
            },
            error: function () {
                alert('Ocurrió un error al cargar los proveedor.');
            }
        });
    }


    $(document).ready(function () {
        
        $('.gastosSelect').each(function () {
            cargarGastos(this);
        });
        $('.proveedorGastosSelect').each(function () {
            cargarProveedoresGastos(this);
        });

        
        $('#agregarFilaGastos').on('click', function (e) {
            e.preventDefault(); 

            
            var nuevaFila = `
                <tr>
                    <td class="p-2 border border-gray-300 text-left">
                        <select name="idgastos" class="gastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Seleccione un gasto</option>
                        </select>
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                         <select name="idproveedorgastos" class="proveedorGastosSelect px-4 py-2 text-sm border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="" disabled selected>Seleccione un proveedor</option>
                        </select>
                    </td>
                    <td class="p-2 border border-gray-300 text-right">
                        <input type="text" id="montogasto" name="montogasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-25" />
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                        <input type="date" name="fechagasto" class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-30" />
                    </td>
                         <td class="p-2 border border-gray-300 text-left">
                                    <textarea rows="2" name="observaciongasto" class="form-control text-left px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"></textarea>
                                </td>
                    <td class="p-2 border border-gray-300 text-right">
                        <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-20 idcuentagastos" readonly />
                    </td>
                    <td class="p-2 border border-gray-300 text-left">
                        <input class="form-control text-right px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 w-48 cuentagastos" readonly />
                    </td>
                    <td style="display:none">
                        <input type="text" class="idsegmentogasto" name="idsegmentogasto" />
                    </td>
                    <td style="display:none;">
                        <input type="hidden" name="IdGastoReal" value="" />
                    </td>
                </tr>
            `;

            
            $('#tablagastos tbody').append(nuevaFila);

            
            $('#tablagastos tbody tr:last .gastosSelect').each(function () {
                cargarGastos(this);
            });
            $('#tablagastos tbody tr:last .proveedorGastosSelect').each(function () {
                cargarProveedoresGastos(this);
            });
        });
    });

   

</script>