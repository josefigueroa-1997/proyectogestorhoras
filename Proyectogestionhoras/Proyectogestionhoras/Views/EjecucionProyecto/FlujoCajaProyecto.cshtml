@using Proyectogestionhoras.Models.DTO
@model Dictionary<string, Dictionary<string, Dictionary<(int Mes, int Anio), List<FlujoCajaProyectosDTO>>>>


@{
    ViewData["Title"] = "Flujo Caja Proyecto";
}


<style>
    .form-container {
    max-width: 1200px;
    margin: 0 auto;
    background-color: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-top: 60px;
    }

    .form-title {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    text-align: center;
    margin-bottom: 10px;
    }

    .form-subtitle {
    font-size: 1.0rem;
    color: #666;
    text-align: center;
    margin-bottom: 20px;
    }



    .highlight {
    background-color: #f8d7da;
    font-weight: bold;
    }

    .panel-container {
    display: flex;
    justify-content: space-between;
    gap: 0px;
    width: 100%;
    margin-top: 0;
    padding-top: 0;
    }

    .panel-item {
    flex-grow: 1;
    border: 2px solid #444;
    border-radius: 0;
    padding: 10px 20px;
    background-color: #f2f3f4;
    color: black;
    text-align: center;
    transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
    }



    .panel-item:hover {
    background-color: #fcaa67;
    color: #fff;
    }
</style>
@{
    int? idproyecto = Context.Session.GetInt32("numproyecto");
    decimal totalingresosreal = 0;
    decimal totalegresosreal = 0;
    decimal? totalmargenreal = 0;
}

<div class="form-container">
    

    <div class="panel-container flex justify-center mb-5">
        <a href="@Url.Action("ForecastIngreso","EjecucionProyecto",new{id=idproyecto})" class="panel-item bg-blue-500 text-white px-4 py-2 rounded-l hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400">
            Forecast Ingresos del Proyecto
        </a>
        <a href="@Url.Action("ForecastCostos","EjecucionProyecto",new{id=idproyecto})" class="panel-item bg-green-500 text-white px-4 py-2 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400">
            Forecast Costos del Proyecto
        </a>
        <a href="@Url.Action("SeleccionarProyecto","EjecucionProyecto",new{statusproyecto=2})" class="panel-item bg-gray-500 text-white px-4 py-2 rounded-r hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-400">
            Seleccionar otro Proyecto
        </a>
    </div>
    <div class="form-group">

        @foreach (var proyecto in ViewBag.Proyecto)
        {

            <p class="form-subtitle" style="color:black;">Información del Proyecto</p>

            <input type="hidden" id="unidadNegocio" value="@proyecto.IDUNEGOCIO" />
            <input type="hidden" id="centroCosto" value="@proyecto.IDCOSTO" />
            <input type="hidden" id="codigo" value="@proyecto.Codigo" />
            <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-collapse">
                    <thead>
                        <tr class="bg-green-100 text-black">
                            <th class="p-2 border border-gray-300 text-left">Número del Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Cliente</th>
                            <th class="p-2 border border-gray-300 text-left">Departamento</th>
                            <th class="p-2 border border-gray-300 text-left">Moneda</th>
                            @if (proyecto.MontoOrigenExtranjero > 0)
                            {
                                <th class="p-2 border border-gray-300 text-left">Monto Moneda Origen</th>
                            }
                            <th class="p-2 border border-gray-300 text-left">MontoCLP</th>
                            <th class="p-2 border border-gray-300 text-left">C.Costo</th>
                            <th class="p-2 border border-gray-300 text-left">Código</th>
                            <th class="p-2 border border-gray-300 text-left">Tipología Proyecto</th>
                            <th class="p-2 border border-gray-300 text-left">Empresa</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.numproyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreProyecto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NombreCliente</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.NOMBREDEPARTAMENTO</td>
                            <td class="p-2 border border-gray-300 text-left" data-moneda="@proyecto.MONEDA">
                                @proyecto.MONEDA
                            </td>
                            @if (proyecto.MontoOrigenExtranjero > 0)
                            {
                                <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MontoOrigenExtranjero)</td>
                            }
                            <td class="p-2 border border-gray-300 text-left">@String.Format("{0:N0}", @proyecto.MontoPresupuesto)</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_CCosto</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Codigo</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Tipologia</td>
                            <td class="p-2 border border-gray-300 text-left">@proyecto.Tipo_Empresa</td>
                        </tr>
                    </tbody>
                </table>
            </div>


        }
    </div>

    <div class="form-group">
        <p class="form-subtitle" style="color:black">Flujo de Caja del Proyecto</p>
        <div class="flex overflow-x-auto">

            <table class="w-full max-w-3xl border-collapse text-left text-xs">
                <thead>
                    <tr class="bg-blue-100 text-black">

                        <th class="p-2 border border-gray-300 text-center">Tipo</th>
                        <th class="p-2 border border-gray-300 text-center">IdCuenta</th>
                        <th class="p-2 border border-gray-300  text-center">Cuenta</th>


                        @{

                            var mesesAnios = new HashSet<(int, int)>();


                            foreach (var proyecto in Model)
                            {
                                foreach (var tipo in proyecto.Value)
                                {
                                    foreach (var mesAnio in tipo.Value.Keys)
                                    {
                                        mesesAnios.Add(mesAnio);
                                    }
                                }
                            }


                            var mesesAniosOrdenados = mesesAnios.OrderBy(ma => ma.Item2).ThenBy(ma => ma.Item1);


                            foreach (var mesAnio in mesesAniosOrdenados)
                            {
                                <th class="p-2 border border-gray-300 text-center" colspan="3">@($"{mesAnio.Item1:D2}-{mesAnio.Item2}")</th>
                            }
                        }
                        <th class="p-2 border border-gray-300 text-center">Total Real</th>
                    </tr>
                    <tr class="bg-gray-200 text-black">

                        <td class="p-2 border border-gray-300 text-center"></td> 
                        <td class="p-2 border border-gray-300 text-center"></td> 
                        <td class="p-2 border border-gray-300 text-center"></td>
                        @foreach (var mesAnio in mesesAniosOrdenados)
                        {
                            <th class="p-2 border border-gray-300  text-center">Proyectado</th>
                            <th class="p-2 border border-gray-300  text-center">Real</th>
                            <th class="p-2 border border-gray-300  text-center">Forecast</th>
                        }
                        <td class="p-2 border border-gray-300 text-center"></td>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var proyecto in Model.OrderBy(p => p.Key))
                    {

                        var totalEgresoProyectadoPorMes = new Dictionary<(int Mes, int Anio), decimal>();
                        var totalEgresoRealPorMes = new Dictionary<(int Mes, int Anio), decimal>();
                        var totalEgresoForecastPorMes = new Dictionary<(int Mes, int Anio), decimal>();
                        var totalIngresoProyectadoPorMes = new Dictionary<(int Mes, int Anio), decimal>();
                        var totalIngresoRealPorMes = new Dictionary<(int Mes, int Anio), decimal>();

                        foreach (var tipo in proyecto.Value)
                        {
                            <tr>

                                <td class="text-left text-xs font-medium sticky left-0 bg-white min-w-[250px]">@tipo.Key</td>

                                @{
                                    var primeraCuenta = tipo.Value.Values
                                            .SelectMany(flujoList => flujoList)
                                            .FirstOrDefault();

                                    var cuenta = primeraCuenta != null ? primeraCuenta.Cuenta : "No disponible";
                                    var idcuenta =  primeraCuenta.IdCuenta ;
                                }
                                <td class="text-left text-xs font-medium ">
                                    @idcuenta
                                </td>
                                <td class="text-left text-xs font-medium min-w-[300px]">
                                    @cuenta
                                </td>
                                @{
                                    decimal totalRealPorFila = 0; 
                                }
                                @foreach (var mesAnio in mesesAniosOrdenados)
                                {

                                    var flujo = tipo.Value
                                    .FirstOrDefault(flujoList =>
                                    flujoList.Key.Item1 == mesAnio.Item1 && flujoList.Key.Item2 == mesAnio.Item2);  // Filtrar por tupla Mes-Año

                                    decimal proyectado = 0;
                                    decimal real = 0;
                                    decimal forecast = 0;

                                    if (flujo.Key != default)
                                    {

                                        proyectado = flujo.Value
                                        .Where(f => f.Estado == "Proyectado")
                                        .Sum(f => f.Monto);

                                        real = flujo.Value
                                        .Where(f => f.Estado == "Real")
                                        .Sum(f => f.Monto);

                                        forecast = flujo.Value
                                        .Where(f => f.Estado == "Forecast")
                                        .Sum(f => f.Monto);
                                    }

                                    <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                        @(proyectado == 0 ? "" : String.Format("{0:N0}", proyectado))
                                    </td>
                                    <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                        @(real == 0 ? "" : String.Format("{0:N0}", real))
                                    </td>
                                    <td class="text-xs border font-medium text-right text-red-500 border-black px-4 py-2 min-w-[100px]">
                                        @(forecast == 0 ? "" : String.Format("{0:N0}", forecast))
                                    </td>
                                    totalRealPorFila += real;
                                    if (tipo.Key != "Ingreso")
                                    {

                                        if (!totalEgresoProyectadoPorMes.ContainsKey(mesAnio)) totalEgresoProyectadoPorMes[mesAnio] = 0;
                                        if (!totalEgresoRealPorMes.ContainsKey(mesAnio)) totalEgresoRealPorMes[mesAnio] = 0;
                                        if (!totalEgresoForecastPorMes.ContainsKey(mesAnio)) totalEgresoForecastPorMes[mesAnio] = 0;

                                        totalEgresoProyectadoPorMes[mesAnio] += proyectado;
                                        totalEgresoRealPorMes[mesAnio] += real;
                                        totalEgresoForecastPorMes[mesAnio] += forecast;
                                    }
                                    if (tipo.Key == "Ingreso")
                                    {
                                        if (!totalIngresoProyectadoPorMes.ContainsKey(mesAnio)) totalIngresoProyectadoPorMes[mesAnio] = 0;
                                        if (!totalIngresoRealPorMes.ContainsKey(mesAnio)) totalIngresoRealPorMes[mesAnio] = 0;
                                        totalIngresoProyectadoPorMes[mesAnio] += proyectado;
                                        totalIngresoRealPorMes[mesAnio] += real;
                                        
                                    }
                                    
                                }
                                <td class="text-xs border font-medium text-right  font-bold border-black px-4 py-2">
                                    @(totalRealPorFila == 0 ? "" : String.Format("{0:N0}", totalRealPorFila))
                                </td>
                            </tr>
                        }

                        @*EGRESOS TOTAL*@
                        <tr class="bg-red-100">
                            <td class="text-left text-xs font-medium font-bold sticky left-0 bg-red-100" >Total Egresos</td>
                            <td class="text-left text-xs font-medium font-bold " ></td>
                            <td class="text-left text-xs font-medium font-bold " ></td>
                            @foreach (var mesAnio in mesesAniosOrdenados)
                            {
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(totalEgresoProyectadoPorMes.GetValueOrDefault(mesAnio, 0) == 0 ? "" : String.Format("{0:N0}", totalEgresoProyectadoPorMes.GetValueOrDefault(mesAnio, 0)))
                                </td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0) == 0 ? "" : String.Format("{0:N0}", totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0)))
                                </td>
                                <td class="text-xs border font-medium text-right  border-black px-4 py-2 min-w-[100px]">
                                    @(totalEgresoForecastPorMes.GetValueOrDefault(mesAnio, 0) == 0 ? "" : String.Format("{0:N0}", totalEgresoForecastPorMes.GetValueOrDefault(mesAnio, 0)))
                                </td>
                                totalegresosreal += totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                            }
                            <td class="text-xs border font-medium text-right  font-bold border-black px-4 py-2">
                                @(totalegresosreal == 0 ? "" : String.Format("{0:N0}", totalegresosreal))
                            </td>
                        </tr>
                        @*MARGEN DEL PROYECTO*@
                        <tr class="bg-gray-300 font-bold">
                            <td class="text-left text-xs font-medium font-bold sticky left-0 bg-gray-300"> Margen del Proyecto</td>
                            <td class="text-left text-xs font-medium font-bold "> </td>
                            <td class="text-left text-xs font-medium font-bold "> </td>
                            @foreach (var mesAnio in mesesAniosOrdenados)
                            {
                                var ingresoproyectado = totalIngresoProyectadoPorMes.GetValueOrDefault(mesAnio, 0);
                                var egresoproyectado = totalEgresoProyectadoPorMes.GetValueOrDefault(mesAnio, 0);
                                var margenproyectado = ingresoproyectado - egresoproyectado;
                                @*Margen real*@
                                var ingresoreal = totalIngresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var egresoreal = totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var margenreal = ingresoreal - egresoreal;

                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(margenproyectado == 0 ? "" : String.Format("{0:N0}", margenproyectado))
                                </td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(margenreal == 0 ? "" : String.Format("{0:N0}", margenreal))
                                </td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]"></td>
                                totalmargenreal += margenreal;
                            }
                            <td class="text-xs border font-medium text-right  font-bold border-black px-4 py-2">
                                @(totalmargenreal == 0 ? "" : String.Format("{0:N0}", totalmargenreal))
                            </td>
                        </tr>
                        @*MARGEN DEL PROYECTO %*@
                        <tr class="bg-green-100 font-bold">
                            <td class="text-left text-xs font-medium font-bold sticky left-0 bg-green-100">Margen del Proyecto (%) </td>
                            <td class="text-left text-xs font-medium font-bold "></td>
                            <td class="text-left text-xs font-medium font-bold "> </td>
                            @foreach (var mesAnio in mesesAniosOrdenados)
                            {

                                var ingresoreal = totalIngresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var egresoreal = totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var margenreal = ingresoreal - egresoreal;
                                var porcentajeMargenReal = ingresoreal > 0 ? Math.Round((margenreal / ingresoreal) * 100, 2) : 0;

                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]"></td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(porcentajeMargenReal == 0 ? "" : String.Format("{0:N0}", porcentajeMargenReal)) %
                                </td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]"></td>
                                totalingresosreal += ingresoreal;
                            }
                            <td class="text-xs border font-medium text-right font-bold border-black px-4 py-2 min-w-[100px]">
                                @{
                                    var porcentajetotalMargenReal = totalingresosreal > 0 && totalmargenreal != null
                                    ? Math.Round(((decimal)totalmargenreal.Value / totalingresosreal) * 100, 2)
                                    : 0;
                                }
                                @porcentajetotalMargenReal.ToString("N0") %
                            </td>
                        </tr>
                        @*SALDO ACUMULADO*@
                        <tr class="bg-yellow-100 font-bold">
                            <td class="text-left text-xs font-medium font-bold sticky left-0 bg-yellow-100" >Saldo Acumulado</td>
                            <td class="text-left text-xs font-medium font-bold " ></td>
                            <td class="text-left text-xs font-medium font-bold " ></td>
                           
                            @foreach (var mesAnio in mesesAniosOrdenados)
                            {
                                var ingresoreal = totalIngresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var egresoreal = totalEgresoRealPorMes.GetValueOrDefault(mesAnio, 0);
                                var margenreal = ingresoreal - egresoreal;
                                ViewBag.SaldoAcumulado = (ViewBag.SaldoAcumulado ?? 0) + margenreal;
                               

                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]"></td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]">
                                    @(ViewBag.SaldoAcumulado == 0 ? "" : String.Format("{0:N0}", ViewBag.SaldoAcumulado))
                                </td>
                                <td class="text-xs border font-medium text-right border-black px-4 py-2 min-w-[100px]"></td>
                            }
                            <td class="text-xs border font-medium text-right font-bold border-black px-4 py-2 min-w-[100px]">
                                @{
                                    decimal? saldoacumuladototal = totalingresosreal - totalmargenreal;
                                }
                                @String.Format("{0:N0}", saldoacumuladototal)
                            </td>
                        </tr>
                    }
                </tbody>
               @* <tbody>

                    <tr >
                        <td class="border font-bold border-gray-300 sticky left-0 bg-white text-center">Ingresos</td>
                        @foreach (var flujo in ViewBag.Flujo)
                        {
                            <td class="px-4 py-2 border border-gray-300 text-center min-w-[50px]">
                                @flujo.Idcuenta
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]">
                                @flujo.Cuenta
                            </td>
                            break;
                        }
                        @foreach (var flujo in ViewBag.Flujo)
                        {

                            <td class="px-4 py-2 font-bold border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoProyectado == 0 ? "" : String.Format("{0:N0}", flujo.MontoProyectado))
                            </td>

                            <td class="px-4 py-2 font-bold border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoReal == 0 ? "" : String.Format("{0:N0}", flujo.MontoReal))
                            </td>
                            <td class="px-4 py-2 font-bold border border-gray-300 text-red-500 text-right min-w-[50px]">
                                @(flujo.MontoPorCobrar == 0 ? "" : String.Format("{0:N0}", flujo.MontoPorCobrar))
                            </td>

                            

                            totalingresosreal += flujo.MontoReal;

                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @String.Format("{0:N0}", totalingresosreal)
                        </td>
                    </tr>



                    
                    <tr>
                        <td class="p-2 border font-bold border-gray-300 text-center sticky left-0 bg-white">HH Socios</td>
                        @foreach (var cuenta in ViewBag.CuentaSocio)
                        {
                            <td class="p-2 border border-gray-300 text-center">@cuenta.Idcuenta</td>
                            <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]">@cuenta.Cuenta</td>
                            break;
                        }

                        @foreach (var flujo in ViewBag.Egresos)
                        {
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontosSocioProyectado == 0 ? "" : String.Format("{0:N0}", flujo.MontosSocioProyectado))
                            </td>

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoSocioReal == 0 ? "" : String.Format("{0:N0}", flujo.MontoSocioReal))
                            </td>
                            <td class="px-4 py-2 border text-red-500 font-bold border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoSocioForecast == 0 ? "" : String.Format("{0:N0}", flujo.MontoSocioForecast))
                            </td>
                            
                            totalsociosreal += flujo.MontoSocioReal;
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @(totalsociosreal == 0 ? "" : String.Format("{0:N0}", totalsociosreal))
                        </td>
                    </tr>


                    
                    <tr>
                        <td class="p-2 border font-bold border-gray-300 text-center sticky left-0 bg-white">HH Staff</td>
                        @foreach (var cuenta in ViewBag.CuentaStaff)
                        {
                            <td class="p-2 border border-gray-300 text-center">@cuenta.Idcuenta</td>
                            <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]">@cuenta.Cuenta</td>
                            break;
                        }
                        @foreach (var flujo in ViewBag.Egresos)
                        {

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontosStaffProyectado == 0 ? "" : String.Format("{0:N0}", flujo.MontosStaffProyectado))
                            </td>

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoStaffReal == 0 ? "" : String.Format("{0:N0}", flujo.MontoStaffReal))
                            </td>
                            <td class="px-4 py-2 border text-red-500 font-bold border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoStaffForecast == 0 ? "" : String.Format("{0:N0}", flujo.MontoStaffForecast))
                            </td>
                            
                            totalstaffreal += flujo.MontoStaffReal;
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @(totalstaffreal == 0 ? "" : String.Format("{0:N0}", totalstaffreal))
                        </td>
                    </tr>




                    <tr>
                        <td class="p-2 border font-bold border-gray-300 text-center sticky left-0 bg-white">HH Consultores</td>
                        @foreach (var cuenta in ViewBag.CuentaConsultor)
                        {
                            <td class="p-2 border border-gray-300 text-center ">@cuenta.Idcuenta</td>
                            <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]" >@cuenta.Cuenta</td>
                            break;
                        }
                        @foreach (var flujo in ViewBag.Egresos)
                        {

                            <td class="px-4 py-2  border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontosConsultoresProyectado == 0 ? "" : String.Format("{0:N0}", flujo.MontosConsultoresProyectado))
                            </td>

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoConsultoresReal == 0 ? "" : String.Format("{0:N0}", flujo.MontoConsultoresReal))
                            </td>
                            <td class="px-4 py-2 border text-red-500 font-bold border-gray-300 text-right min-w-[50px]">
                                @(flujo.MontoConsultoresForecast == 0 ? "" : String.Format("{0:N0}", flujo.MontoConsultoresForecast))
                            </td>
                            
                            totalconsultoresreal += flujo.MontoConsultoresReal;
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @(totalconsultoresreal == 0 ? "" : String.Format("{0:N0}", totalconsultoresreal))
                        </td>
                    </tr>

                    




                    @foreach (var grupo in ViewBag.Servicios)
                    {
                       
                        bool hayServiciosConValor = false;

                        
                        @foreach (var servicio in grupo.Servicios)
                        {
                            if (servicio.MontosServiciosProyectado > 0 || servicio.MontoSerivicioReal > 0)
                            {
                                hayServiciosConValor = true;
                                break; 
                            }
                        }

                        
                        if (hayServiciosConValor)
                        {
                            <tr>
                                <td class="p-2 font-bold border border-gray-300 text-center sticky left-0 bg-white" rowspan="1">@grupo.ServicioNombre</td>
                                @foreach (var servicio in grupo.Servicios)
                                {
                                    @if (@servicio.idcuentaservicio > 0)
                                    {
                                        <td class="px-4 py-2 border border-gray-300 text-center min-w-[50px]">
                                            @servicio.idcuentaservicio
                                        </td>
                                        <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]">
                                            @servicio.CuentaServicio
                                        </td>
                                        break;
                                    }
                                }
                                @{var totalserviciosreales = 0m;}
                                @foreach (var servicio in grupo.Servicios)
                                {
                                    <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                        @(servicio.MontosServiciosProyectado == 0 ? "" : String.Format("{0:N0}", servicio.MontosServiciosProyectado))
                                    </td>
                                    <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                        @(servicio.MontoSerivicioReal == 0 ? "" : String.Format("{0:N0}", servicio.MontoSerivicioReal))
                                    </td>
                                    <td class="px-4 py-2 font-bold border border-gray-300 text-red-500 text-right min-w-[50px]">
                                        @(servicio.MontosServiciosForecast == 0 ? "" : String.Format("{0:N0}", servicio.MontosServiciosForecast))
                                    </td>
                                    totalserviciosreales += servicio.MontoSerivicioReal;
                                }
                                <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                                    @(totalserviciosreales == 0 ? "" : String.Format("{0:N0}", totalserviciosreales))
                                </td>
                            </tr>
                        }
                    }

                    
                 
                    @if (ViewBag.Gastos != null && ViewBag.Gastos.Count > 0)
                    {
                        @foreach (var grupo in ViewBag.Gastos)
                        {
                            
                            bool hayGastosConValor = false;

                           
                            @foreach (var gasto in grupo.Gastos)
                            {
                                if (gasto.MontosGastosProyectado > 0 || gasto.MontoGastoReal > 0)
                                {
                                    hayGastosConValor = true;
                                    break; 
                                }
                            }

                            
                            if (hayGastosConValor)
                            {
                                <tr>
                                    <td class="p-2 font-bold border border-gray-300 text-center sticky left-0 bg-white" rowspan="1">@grupo.GastosNombres</td>
                                    @foreach (var gasto in grupo.Gastos)
                                    {
                                        @if (@gasto.idcuentagasto > 0)
                                        {
                                            <td class="px-4 py-2 border border-gray-300 text-center min-w-[50px]">
                                                @gasto.idcuentagasto
                                            </td>
                                            <td class="px-4 py-2 border border-gray-300 text-left min-w-[100px]">
                                                @gasto.Cuentagasto
                                            </td>
                                        }
                                        break;
                                    }
                                    @{
                                        var totalgastosreal = 0m;
                                    }
                                    @foreach (var gasto in grupo.Gastos)
                                    {
                                        <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                            @(gasto.MontosGastosProyectado == 0 ? "" : String.Format("{0:N0}", gasto.MontosGastosProyectado))
                                        </td>
                                        <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                            @(gasto.MontoGastoReal == 0 ? "" : String.Format("{0:N0}", gasto.MontoGastoReal))
                                        </td>
                                        <td class="px-4 py-2 font-bold border border-gray-300 text-red-500 text-right min-w-[50px]">
                                            @(gasto.MontosGastosForecast == 0 ? "" : String.Format("{0:N0}", gasto.MontosGastosForecast))
                                        </td>
                                        
                                        totalgastosreal += gasto.MontoGastoReal;
                                    }
                                    <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                                        @(totalgastosreal == 0 ? "" : String.Format("{0:N0}", totalgastosreal))
                                    </td>
                                </tr>
                            }
                        }
                    }
                   
                    
                   

                   <tr class="font-bold">
                        <td class="p-2 border border-gray-300 text-center sticky left-0 bg-white">Total Egresos</td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        @for (int i = 0; i < flujoList.Count; i++)
                        {
                            var flujoActual = flujoList[i];
                            var totalProyectado = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontosSocioProyectado ?? 0) +
                            (e.MontosStaffProyectado ?? 0) +
                            (e.MontosConsultoresProyectado ?? 0));


                            var totalReal = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontoSocioReal ?? 0) +
                            (e.MontoStaffReal ?? 0) +
                            (e.MontoConsultoresReal ?? 0) 
                            );

                            var totalForecast = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontoSocioForecast ?? 0) +
                            (e.MontoStaffForecast ?? 0) +
                            (e.MontoConsultoresForecast ?? 0)
                            );

                            
                            decimal totalServiciosProyectado = 0;
                            decimal totalServiciosReal = 0;
                            decimal totalServiciosForecast = 0;

                            foreach (var grupo in ViewBag.Servicios)
                            {
                                foreach (var servicio in grupo.Servicios)
                                {
                                    if (servicio.Mes == flujoActual.Mes && servicio.Anio == flujoActual.Anio)
                                    {
                                        totalServiciosProyectado += servicio.MontosServiciosProyectado ?? 0;
                                        totalServiciosReal += servicio.MontoSerivicioReal ?? 0;
                                        totalServiciosForecast += servicio.MontosServiciosForecast ?? 0;
                                    }
                                }
                            }

                            decimal totalGastosProyectado = 0;
                            decimal totalGastosReal = 0;
                            decimal totalGastosForecast = 0;

                           foreach (var grupo in ViewBag.Gastos)
                            {
                                foreach (var gasto in grupo.Gastos)
                                {
                                    if (gasto.Mes == flujoActual.Mes && gasto.Anio == flujoActual.Anio)
                                    {
                                        totalGastosProyectado += gasto.MontosGastosProyectado ?? 0;
                                        totalGastosReal += gasto.MontoGastoReal ?? 0;
                                        totalGastosForecast += gasto.MontosGastosForecast ?? 0;
                                    }
                                }
                            }

                            <td  class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @String.Format("{0:N0}", totalProyectado + totalServiciosProyectado + totalGastosProyectado)
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @String.Format("{0:N0}", totalReal + totalServiciosReal + totalGastosReal)
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-red-500 text-right min-w-[50px]">
                                @String.Format("{0:N0}", totalForecast + totalServiciosForecast + totalGastosForecast)
                            </td>
                            totalegresosreal += totalReal + totalServiciosReal + totalGastosReal;
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @(totalegresosreal == 0 ? "" : String.Format("{0:N0}", totalegresosreal))
                        </td>
                    </tr>
                    







                    <tr class="bg-gray-300 font-bold">
                        <td class="p-2 border border-gray-300 text-center sticky left-0 bg-gray-300">Margen del Proyecto</td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        @for (int i = 0; i < flujoList.Count; i++)
                        {
                            var flujoActual = flujoList[i];

                            // Ingresos
                            var ingresoProyectado = flujoActual.MontoProyectado;
                            var ingresoReal = flujoActual.MontoReal;

                            // Total Egresos
                            var totalEgresosProyectado = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontosSocioProyectado ?? 0) +
                            (e.MontosStaffProyectado ?? 0) +
                            (e.MontosConsultoresProyectado ?? 0) );

                            var totalEgresosReal = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontoSocioReal ?? 0) +
                            (e.MontoStaffReal ?? 0) +
                            (e.MontoConsultoresReal ?? 0));

                            decimal totalServiciosProyectado = 0;
                            decimal totalServiciosReal = 0;

                            foreach (var grupo in ViewBag.Servicios)
                            {
                                foreach (var servicio in grupo.Servicios)
                                {
                                    if (servicio.Mes == flujoActual.Mes && servicio.Anio == flujoActual.Anio)
                                    {
                                        totalServiciosProyectado += servicio.MontosServiciosProyectado ?? 0;
                                        totalServiciosReal += servicio.MontoSerivicioReal ?? 0;
                                    }
                                }
                            }

                            decimal totalGastosProyectado = 0;
                            decimal totalGastosReal = 0;

                            foreach (var grupo in ViewBag.Gastos)
                            {
                                foreach (var gasto in grupo.Gastos)
                                {
                                    if (gasto.Mes == flujoActual.Mes && gasto.Anio == flujoActual.Anio)
                                    {
                                        totalGastosProyectado += gasto.MontosGastosProyectado ?? 0;
                                        totalGastosReal += gasto.MontoGastoReal ?? 0;
                                    }
                                }
                            }

                            // Margen
                            var margenProyectado = ingresoProyectado - (totalEgresosProyectado + totalGastosProyectado + totalServiciosProyectado);
                            var margenReal = ingresoReal - (totalEgresosReal + totalGastosReal + totalServiciosReal);

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @String.Format("{0:N0}", margenProyectado)
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @String.Format("{0:N0}", margenReal)
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                            </td>
                            totalmargenreal += margenReal;
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @(totalmargenreal == 0 ? "" : String.Format("{0:N0}", totalmargenreal))
                        </td>
                    </tr>
                    
                    <tr class="bg-green-100 font-bold">
                        <td class="p-2 border border-gray-300 text-center sticky left-0 bg-green-100">Margen de Proyecto Real (%)</td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        @for (int i = 0; i < flujoList.Count; i++)
                        {
                            var flujoActual = flujoList[i];

                            
                            var ingresoReal = flujoActual.MontoReal;

                            
                            var totalEgresosReal = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontoSocioReal ?? 0) +
                            (e.MontoStaffReal ?? 0) +
                            (e.MontoConsultoresReal ?? 0) +
                            (e.MontoSerivicioReal ?? 0) +
                            (e.MontoGastoReal ?? 0));


                            
                            decimal totalServiciosReal = 0;

                            foreach (var grupo in ViewBag.Servicios)
                            {
                                foreach (var servicio in grupo.Servicios)
                                {
                                    if (servicio.Mes == flujoActual.Mes && servicio.Anio == flujoActual.Anio)
                                    {
                                        
                                        totalServiciosReal += servicio.MontoSerivicioReal ?? 0;
                                    }
                                }
                            }

                           
                            decimal totalGastosReal = 0;

                            foreach (var grupo in ViewBag.Gastos)
                            {
                                foreach (var gasto in grupo.Gastos)
                                {
                                    if (gasto.Mes == flujoActual.Mes && gasto.Anio == flujoActual.Anio)
                                    {
                                        
                                        totalGastosReal += gasto.MontoGastoReal ?? 0;
                                    }
                                }
                            }

                            
                           
                            var margenReal = ingresoReal - (totalEgresosReal + totalGastosReal + totalServiciosReal);

                           
                            var porcentajeMargenReal = ingresoReal > 0 && margenReal != null
                            ? Math.Round(((decimal)margenReal / ingresoReal.Value) * 100, 2)
                            : 0; 

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                               
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @porcentajeMargenReal.ToString("N0") %
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                            </td>
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right font-bold min-w-[50px]">
                            @{
                                var porcentajetotalMargenReal = totalingresosreal > 0 && totalmargenreal != null
                                ? Math.Round(((decimal)totalmargenreal.Value / totalingresosreal) * 100, 2)
                            : 0;}
                            @porcentajetotalMargenReal.ToString("N0") %
                        </td>
                    </tr>
                    
                    <tr class="bg-yellow-100 font-bold">
                        <td class="p-2 border border-gray-300 text-center sticky left-0 bg-yellow-100">Saldo Acumulado</td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        <td class="p-2 border border-gray-300 text-center"></td>
                        @for (int i = 0; i < flujoList.Count; i++)
                        {
                            var flujoActual = flujoList[i];

                            var ingresoReal = flujoActual.MontoReal;

                           
                            var totalEgresosReal = egresosList
                            .Where(e => e.Mes == flujoActual.Mes && e.Anio == flujoActual.Anio)
                            .Sum(e => (e.MontoSocioReal ?? 0) +
                            (e.MontoStaffReal ?? 0) +
                            (e.MontoConsultoresReal ?? 0) +
                            (e.MontoSerivicioReal ?? 0) +
                            (e.MontoGastoReal ?? 0));

                            decimal totalServiciosReal = 0;

                            foreach (var grupo in ViewBag.Servicios)
                            {
                                foreach (var servicio in grupo.Servicios)
                                {
                                    if (servicio.Mes == flujoActual.Mes && servicio.Anio == flujoActual.Anio)
                                    {

                                        totalServiciosReal += servicio.MontoSerivicioReal ?? 0;
                                    }
                                }
                            }


                            decimal totalGastosReal = 0;

                            foreach (var grupo in ViewBag.Gastos)
                            {
                                foreach (var gasto in grupo.Gastos)
                                {
                                    if (gasto.Mes == flujoActual.Mes && gasto.Anio == flujoActual.Anio)
                                    {

                                        totalGastosReal += gasto.MontoGastoReal ?? 0;
                                    }
                                }
                            }

                            var margenReal = ingresoReal - (totalEgresosReal + totalGastosReal + totalServiciosReal);

                            
                            ViewBag.SaldoAcumulado = (ViewBag.SaldoAcumulado ?? 0) + margenReal;

                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                
                            </td>
                            
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                                @String.Format("{0:N0}", ViewBag.SaldoAcumulado)
                            </td>
                            <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                            </td>
                        }
                        <td class="px-4 py-2 border border-gray-300 text-right min-w-[50px]">
                            @{
                                decimal? saldoacumuladototal = totalingresosreal - totalmargenreal;
                            }
                            @String.Format("{0:N0}", saldoacumuladototal)
                        </td>
                    </tr>
                </tbody>*@
            </table>
        </div>
    </div>

</div>

